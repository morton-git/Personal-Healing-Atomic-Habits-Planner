<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>個人療癒原子習慣計畫本 | 養成好習慣，成就更好的自己 🌿</title>

    <!-- 基本 SEO 標籤 -->
    <meta name="description" content="幫助您建立並追蹤個人習慣，提供每日療癒建議，讓養成好習慣變得簡單又有趣。">
    <meta name="keywords" content="習慣養成, 原子習慣, 個人成長, 自我提升, 習慣追蹤, 療癒, 心靈成長">
    <meta name="author" content="個人療癒原子習慣計畫本">

    <!-- 網站圖示 -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🌿</text></svg>">
    <!-- 引入 Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 Google Fonts：Inter 用於通用字體，Noto Sans TC 用於中文，Playfair Display 用於標題斜體 -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+TC:wght@300;400,700&family=Playfair+Display:ital@1&display=swap" rel="stylesheet">
    <style>
        /* 定義 CSS 變數，方便統一管理顏色和字體 */
        :root {
            --primary-bg: #F8F4E3; /* 淺米色 */
            --secondary-bg: #EAF4E3; /* 淺綠色 */
            --text-color: #4A4A4A;
            --header-color: #6B8E23; /* 橄欖綠 */
            --accent-color: #A2D99A; /* 柔和綠 */
            --border-color: #D3D3D3;
            --shadow-light: rgba(0, 0, 0, 0.05);
            --modal-bg: #fefefe;
            --priority-low: #8BC34A; /* 淺綠 */
            --priority-medium: #FFC107; /* 琥珀黃 */
            --priority-high: #F44336; /* 紅色 */
        }

        /* 深色模式變數 */
        body.dark-mode {
            --primary-bg: #333333;
            --secondary-bg: #444444;
            --text-color: #E0E0E0;
            --header-color: #A2D99A;
            --accent-color: #6B8E23;
            --border-color: #555555;
            --shadow-light: rgba(255, 255, 255, 0.1);
            --modal-bg: #2b2b2b;
            --priority-low: #6B8E23; /* 深綠 */
            --priority-medium: #FFD700; /* 金黃 */
            --priority-high: #EF5350; /* 深紅 */
        }

        /* 基本 body 樣式 */
        body {
            font-family: 'Noto Sans TC', 'Inter', sans-serif; /* 優先使用中文，其次英文 */
            background-color: var(--primary-bg);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* 讓內容從頂部開始排列 */
            min-height: 100vh;
            box-sizing: border-box;
            transition: background-color 0.3s ease, color 0.3s ease; /* 主題切換過渡 */
        }

        /* 容器樣式 */
        .container {
            background-color: #FFFFFF; /* 容器背景色固定為白色，或改為 var(--modal-bg) */
            border-radius: 15px;
            box-shadow: 0 10px 30px var(--shadow-light);
            padding: 30px;
            max-width: 800px; /* 最大寬度 */
            width: 100%; /* 響應式寬度 */
            display: flex; /* 使用 flexbox 佈局 */
            flex-direction: column; /* 垂直排列 */
            gap: 25px; /* 元素間距 */
            transition: background-color 0.3s ease, box-shadow 0.3s ease; /* 主題切換過渡 */
        }
        body.dark-mode .container {
            background-color: var(--modal-bg);
        }

        /* 標題樣式 */
        h1 {
            color: var(--header-color);
            font-size: 2.2em;
            text-align: center;
            margin-bottom: 20px;
            font-weight: 700;
        }

        /* 語錄區塊樣式 */
        .quote-box {
            background-color: var(--secondary-bg);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            font-style: italic;
            font-size: 1.1em;
            color: var(--header-color);
            border: 1px solid var(--accent-color);
            line-height: 1.6;
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }

        .quote-box span {
            display: block;
            margin-top: 10px;
            font-size: 0.9em;
            color: var(--text-color);
            transition: color 0.3s ease;
        }

        /* 任務區塊標題樣式 */
        .task-section h2 {
            color: var(--header-color);
            font-size: 1.6em;
            margin-bottom: 15px;
            border-bottom: 2px solid var(--accent-color);
            padding-bottom: 5px;
            transition: color 0.3s ease, border-color 0.3s ease;
        }

        /* 任務表格樣式 */
        .task-table {
            width: 100%;
            border-collapse: separate; /* 允許 border-spacing */
            border-spacing: 0 8px; /* 列間距 */
        }

        .task-table th, .task-table td {
            padding: 12px 15px;
            text-align: left;
            vertical-align: top;
        }

        .task-table th {
            background-color: var(--accent-color);
            color: white;
            font-weight: 400;
            /* 頂部圓角 */
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            transition: background-color 0.3s ease;
        }

        /* 任務行單元格樣式 */
        .task-table td {
            background-color: var(--primary-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 2px 5px var(--shadow-light);
            transition: background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
        }

        /* 任務行 hover 效果 */
        .task-table tr:hover td {
            background-color: #FCFBF4;
        }
        body.dark-mode .task-table tr:hover td {
            background-color: #555555;
        }

        /* 進度勾選框單元格樣式 */
        .task-table td:nth-last-child(3) { /* 倒數第三個 td 是進度勾選框 */
            width: 60px; /* 進度勾選框寬度 */
            text-align: center;
        }
        /* 編輯和刪除按鈕單元格樣式 */
        .task-table td:nth-last-child(2),
        .task-table td:last-child {
            width: 40px; /* 刪除按鈕寬度 */
            text-align: center;
        }

        /* 任務列表為空時的樣式 */
        .empty-task-list-message {
            text-align: center;
            padding: 20px;
            color: var(--text-color);
            font-style: italic;
            background-color: var(--secondary-bg);
            border-radius: 10px;
            margin-top: 10px;
            border: 1px dashed var(--accent-color);
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }


        /* 勾選框樣式 */
        input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: var(--header-color); /* 改變勾選框顏色 */
            cursor: pointer;
            border-radius: 4px; /* 圓角勾選框 */
            transition: accent-color 0.3s ease;
        }

        /* 任務完成動畫 */
        .task-completed-animation {
            animation: taskFadeOut 0.5s forwards;
        }
        @keyframes taskFadeOut {
            0% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-10px); }
        }

        /* 按鈕組樣式 */
        .button-group {
            display: flex;
            flex-wrap: wrap; /* 換行 */
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        /* 行動按鈕樣式 */
        .action-button {
            background-color: var(--header-color);
            color: white;
            padding: 15px 25px;
            border: none;
            border-radius: 30px; /* 圓角按鈕 */
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease; /* 過渡效果 */
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .action-button:hover {
            background-color: #557A1F; /* 深一點的綠色 */
            transform: translateY(-2px); /* 輕微上浮效果 */
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
        }
        .action-button:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        /* 圖片畫廊樣式 */
        .image-gallery {
            text-align: center;
            margin-top: 30px;
        }

        .image-gallery a {
            display: block; /* 讓連結佔滿整個區塊 */
            text-decoration: none;
            color: var(--text-color);
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            background-color: var(--primary-bg);
            box-shadow: 0 5px 15px var(--shadow-light);
            transition: all 0.3s ease;
            font-size: 1.1em; /* 調整字體大小 */
            font-weight: 500; /* 調整字體粗細 */
            color: var(--header-color); /* 調整文字顏色 */
        }

        .image-gallery a:hover {
            background-color: #FCFBF4;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }
        body.dark-mode .image-gallery a:hover {
            background-color: #555555;
        }

        /* 底部連結樣式 */
        .footer-links {
            text-align: center;
            margin-top: 30px;
            font-size: 0.95em;
        }
        .footer-links a {
            color: var(--header-color);
            text-decoration: none;
            margin: 0 10px;
            transition: color 0.3s ease;
        }
        .footer-links a:hover {
            color: var(--text-color);
        }

        /* 設定頁面專用樣式 */
        #setupPage {
            padding: 20px;
            background-color: var(--modal-bg); /* 使用 modal 背景色 */
            border-radius: 15px;
            box-shadow: 0 5px 15px var(--shadow-light);
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }

        #setupPage label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--header-color);
            transition: color 0.3s ease;
        }

        #setupPage input[type="text"],
        #setupPage textarea,
        #setupPage select {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-sizing: border-box; /* 確保 padding 不增加寬度 */
            font-family: 'Noto Sans TC', 'Inter', sans-serif;
            font-size: 1em;
            color: var(--text-color);
            background-color: var(--primary-bg); /* 輸入框背景色 */
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }

        #setupPage textarea {
            min-height: 80px;
            resize: vertical;
        }

        #setupPage .checkbox-group {
            margin-bottom: 15px;
        }

        #setupPage .checkbox-group label {
            display: inline-flex; /* 讓 checkbox 和文字在同一行 */
            align-items: center;
            margin-right: 15px;
            margin-bottom: 5px;
            font-weight: 400;
            color: var(--text-color);
            transition: color 0.3s ease;
        }

        #setupPage .checkbox-group input[type="checkbox"] {
            margin-right: 8px;
            width: 18px;
            height: 18px;
        }

        #setupPage button {
            width: auto;
            padding: 12px 30px;
            font-size: 1.2em;
        }

        /* 隱藏元素 */
        .hidden {
            display: none;
        }

        /* 任務新增彈窗樣式 */
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4); /* 半透明背景 */
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0; /* 初始隱藏 */
            visibility: hidden; /* 初始隱藏 */
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal.show {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: var(--modal-bg); /* 使用變數 */
            margin: auto;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            max-width: 500px;
            width: 90%;
            position: relative;
            transform: translateY(-20px); /* 初始位置，用於動畫 */
            transition: background-color 0.3s ease, transform 0.3s ease;
        }
        .modal.show .modal-content {
            transform: translateY(0); /* 顯示時回到原位 */
        }

        .modal-content h3 {
            color: var(--header-color);
            font-size: 1.8em;
            margin-bottom: 20px;
            text-align: center;
        }

        .modal-content .form-group {
            margin-bottom: 15px;
        }

        .modal-content label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--text-color);
        }

        .modal-content input[type="text"],
        .modal-content input[type="date"], /* 新增日期輸入框樣式 */
        .modal-content textarea,
        .modal-content select { /* 新增選擇框樣式 */
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-sizing: border-box;
            font-family: 'Noto Sans TC', 'Inter', sans-serif;
            font-size: 1em;
            color: var(--text-color);
            background-color: var(--primary-bg); /* 輸入框背景色 */
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }
        /* 錯誤訊息樣式 */
        .error-message {
            color: #FF6347; /* 番茄紅 */
            font-size: 0.9em;
            margin-top: -10px;
            margin-bottom: 10px;
            text-align: center;
        }

        .modal-content .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        /* 行動按鈕樣式 (已在上方定義 .action-button) */
        /* 取消按鈕樣式調整，使其與 action-button 保持相同尺寸和圓角 */
        .modal-content .modal-buttons .cancel-button {
            background-color: #ccc; /* 淺色模式背景 */
            color: var(--text-color);
            border: 1px solid var(--border-color); /* 添加邊框 */
            padding: 15px 25px; /* 與 action-button 相同 */
            border-radius: 30px; /* 與 action-button 相同 */
            font-size: 1.1em; /* 與 action-button 相同 */
            cursor: pointer;
            transition: background-color 0.3s ease, border-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); /* 與 action-button 相同 */
        }

        .modal-content .modal-buttons .cancel-button:hover {
            background-color: #bbb; /* 淺色模式 hover 背景 */
            transform: translateY(-2px); /* 輕微上浮效果 */
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2); /* 輕微陰影擴散 */
        }
        body.dark-mode .modal-content .modal-buttons .cancel-button {
            background-color: #666; /* 深色模式背景 */
            color: #eee;
            border-color: #888; /* 深色模式邊框顏色 */
        }
        body.dark-mode .modal-content .modal-buttons .cancel-button:hover {
            background-color: #777; /* 深色模式 hover 背景 */
            border-color: #aaa; /* 深色模式 hover 邊框顏色 */
        }

        /* 編輯按鈕樣式 */
        .edit-button {
            background: none;
            border: none;
            color: #1E90FF; /* 道奇藍 */
            font-size: 1.2em;
            cursor: pointer;
            transition: color 0.2s ease;
            padding: 0;
            margin: 0;
            line-height: 1; /* 確保垂直對齊 */
            margin-right: 8px; /* 與刪除按鈕間距 */
        }
        .edit-button:hover {
            color: #007BFF;
        }

        /* 刪除按鈕樣式 */
        .delete-button {
            background: none;
            border: none;
            color: #FF6347; /* 番茄紅 */
            font-size: 1.2em;
            cursor: pointer;
            transition: color 0.2s ease;
            padding: 0;
            margin: 0;
            line-height: 1; /* 確保垂直對齊 */
        }
        .delete-button:hover {
            color: #CC0000;
        }

        /* 籤詩彈窗內容樣式 */
        #oracleModal .oracle-content {
            font-size: 1.2em;
            line-height: 1.8;
            text-align: center;
            margin-bottom: 20px;
            color: var(--header-color);
            font-weight: 600;
        }
        #oracleModal .oracle-content p {
            margin-bottom: 10px;
        }
        #oracleModal .oracle-content span {
            display: block;
            margin-top: 10px;
            font-size: 0.9em;
            color: var(--text-color);
        }
        /* 籤詩主題選項 */
        #oracleModal .theme-options {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        #oracleModal .theme-options label {
            background-color: var(--primary-bg);
            padding: 8px 15px;
            border-radius: 20px;
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 400;
            color: var(--text-color);
            display: flex;
            align-items: center;
        }
        #oracleModal .theme-options input[type="radio"] {
            margin-right: 8px;
            accent-color: var(--header-color);
            width: 16px;
            height: 16px;
        }
        #oracleModal .theme-options label:hover,
        #oracleModal .theme-options input[type="radio"]:checked {
            background-color: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }
        #oracleModal .theme-options input[type="radio"]:checked + span {
            color: white; /* 確保選中文字是白色 */
        }
        #oracleModal .theme-options input[type="radio"]:checked + span::before {
            content: '✓ ';
            color: white;
        }


        /* 新增：光點與心情區塊樣式 */
        .status-section {
            background-color: var(--secondary-bg);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            color: var(--header-color);
            border: 1px solid var(--accent-color);
            display: flex;
            flex-wrap: wrap;
            justify-content: space-around;
            gap: 15px;
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }
        .status-item {
            flex: 1 1 auto; /* 彈性佈局 */
            min-width: 120px; /* 最小寬度 */
            font-size: 1.1em;
            font-weight: 500;
        }
        .status-item span {
            display: block;
            font-size: 1.8em;
            font-weight: 700;
            color: var(--text-color);
            margin-top: 5px;
            transition: transform 0.2s ease-out, color 0.3s ease; /* 光點動畫過渡 */
        }
        .status-item span.pulse-animation {
            animation: pulse 0.3s ease-out; /* 光點動畫 */
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .status-item.mood {
            flex-basis: 100%; /* 心情日記佔滿一行 */
            text-align: left;
        }
        .status-item.mood span {
            font-size: 1.2em;
            font-weight: 400;
            color: var(--text-color);
            margin-top: 0;
        }
        .status-item.streak-reason {
            flex-basis: 100%;
            text-align: left;
        }
        .status-item.streak-reason input {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            font-size: 0.95em;
            box-sizing: border-box;
            margin-top: 5px;
            background-color: var(--primary-bg);
            color: var(--text-color);
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }
        .status-item.streak-reason input::placeholder {
            color: #A0A0A0;
        }
        body.dark-mode .status-item.streak-reason input::placeholder {
            color: #888888;
        }
        .status-item.streak-message {
            flex-basis: 100%;
            font-size: 0.95em;
            font-style: italic;
            color: #6B8E23; /* 橄欖綠 */
            margin-top: -10px; /* 調整與上方間距 */
            transition: color 0.3s ease;
        }

        /* 心情日記彈窗樣式 */
        #moodModal .modal-content {
            max-width: 450px;
        }
        #moodModal .mood-options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
            justify-content: center;
        }
        #moodModal .mood-options label {
            display: flex;
            align-items: center;
            background-color: var(--primary-bg);
            padding: 8px 15px;
            border-radius: 20px;
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 400;
            color: var(--text-color);
        }
        #moodModal .mood-options input[type="radio"] {
            margin-right: 8px;
            accent-color: var(--header-color);
            width: 16px;
            height: 16px;
        }
        #moodModal .mood-options label:hover {
            background-color: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }
        #moodModal .mood-options input[type="radio"]:checked {
            background-color: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }
        #moodModal .mood-options input[type="radio"]:checked + span {
            font-weight: 600;
            color: white; /* 確保選中文字是白色 */
        }
        #moodModal .mood-options input[type="radio"]:checked + span::before {
            content: '✓ '; /* 選中時前面加個勾 */
            color: white;
        }
        #moodModal textarea {
            min-height: 80px; /* 調整高度 */
        }

        /* 過去心情回顧區塊 */
        .mood-history-section {
            background-color: var(--secondary-bg);
            border-radius: 10px;
            padding: 20px;
            text-align: left;
            color: var(--header-color);
            border: 1px solid var(--accent-color);
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }
        .mood-history-section h2 {
            color: var(--header-color);
            font-size: 1.4em;
            margin-bottom: 10px;
            border-bottom: 1px solid var(--accent-color);
            padding-bottom: 5px;
            transition: color 0.3s ease, border-color 0.3s ease;
        }
        .mood-history-section ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .mood-history-section li {
            padding: 5px 0;
            border-bottom: 1px dashed var(--border-color);
            font-size: 0.95em;
            color: var(--text-color);
            transition: border-color 0.3s ease, color 0.3s ease;
        }
        .mood-history-section li:last-child {
            border-bottom: none;
        }
        .mood-history-section li strong {
            color: var(--header-color);
            margin-right: 8px;
            transition: color 0.3s ease;
        }

        /* 複製成功提示訊息 */
        #copySuccessMessage {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #4CAF50; /* 綠色 */
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }
        #copySuccessMessage.show {
            opacity: 1;
        }

        /* 載入指示器樣式 */
        .loading-indicator {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0; /* 初始隱藏 */
            visibility: hidden; /* 初始隱藏 */
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }

        .loading-indicator.show {
            opacity: 1;
            visibility: visible;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        .loading-text {
            color: white;
            font-size: 1.2em;
            font-weight: 500;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 全局錯誤提示條 */
        #globalErrorMessage {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background-color: #ef4444; /* Red-500 */
            color: white;
            text-align: center;
            padding: 10px 0;
            font-weight: bold;
            z-index: 1500;
            opacity: 0; /* 預設隱藏 */
            visibility: hidden; /* 預設隱藏 */
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        #globalErrorMessage.show {
            opacity: 1;
            visibility: visible;
        }


        /* 離線提示條 */
        #offlineMessage {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background-color: #f59e0b; /* Amber-500 */
            color: white;
            text-align: center;
            padding: 10px 0;
            font-weight: bold;
            z-index: 1500;
            display: none; /* 預設隱藏 */
            transition: background-color 0.3s ease;
        }

        /* 優先級標籤樣式 */
        .priority-tag {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
            margin-left: 5px;
            color: white;
            text-transform: uppercase;
        }

        .priority-low {
            background-color: var(--priority-low);
        }
        .priority-medium {
            background-color: var(--priority-medium);
        }
        .priority-high {
            background-color: var(--priority-high);
        }


        /* 響應式調整 */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            .container {
                padding: 20px;
                gap: 15px;
            }
            h1 {
                font-size: 1.8em;
            }
            .quote-box {
                padding: 15px;
                font-size: 1em;
            }
            .task-section h2 {
                font-size: 1.4em;
            }
            .task-table th, .task-table td {
                padding: 8px 10px;
                font-size: 0.9em;
            }
            /* 任務表格在小螢幕上可能需要滾動 */
            .task-section {
                overflow-x: auto;
            }
            .task-table {
                min-width: 500px; /* 確保表格內容不會擠壓 */
            }
            .status-item {
                min-width: unset; /* 移除最小寬度限制 */
                flex-basis: 48%; /* 兩列佈局 */
            }
            .status-item.mood, .status-item.streak-reason, .status-item.streak-message {
                flex-basis: 100%; /* 這些項目仍然佔滿一行 */
            }
            #setupPage input[type="text"],
            #setupPage textarea,
            #setupPage select {
                font-size: 0.95em;
            }
            .modal-content {
                padding: 20px;
                width: 95%;
            }
            .modal-content h3 {
                font-size: 1.5em;
            }
            .modal-content .modal-buttons {
                flex-direction: column;
                gap: 10px;
            }
            .modal-content .modal-buttons button {
                width: 100%;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 5px;
            }
            .container {
                padding: 15px;
            }
            h1 {
                font-size: 1.6em;
            }
            .quote-box {
                font-size: 0.9em;
            }
            .task-section h2 {
                font-size: 1.2em;
            }
            .task-table th, .task-table td {
                padding: 6px 8px;
                font-size: 0.85em;
            }
            /* 任務表格在小螢幕上可能需要滾動 */
            .task-section {
                overflow-x: auto;
            }
            .task-table {
                min-width: 500px; /* 確保表格內容不會擠壓 */
            }
            .status-item {
                flex-basis: 100%; /* 單列佈局 */
            }
            .footer-links a {
                display: block;
                margin: 5px 0;
            }
        }
    </style>
</head>
<body>
    <!-- 全局錯誤提示條 -->
    <div id="globalErrorMessage" class="global-error-message" role="alert" aria-live="assertive"></div>
    <!-- 離線提示條 -->
    <div id="offlineMessage" class="hidden" role="status" aria-live="polite">您目前處於離線狀態，部分功能可能無法使用。</div>

    <!-- 載入指示器 -->
    <div id="loadingIndicator" class="loading-indicator" role="status" aria-live="assertive">
        <div class="loading-spinner"></div>
        <div class="loading-text">處理中，請稍候...</div>
    </div>

    <div class="container">
        <!-- 設定頁面 -->
        <div id="setupPage" class="hidden">
            <h1 aria-label="歡迎來到個人療癒原子習慣計畫本">歡迎來到個人療癒原子習慣計畫本！📝</h1>
            <p class="text-center text-lg mb-6 text-gray-600">請告訴我們你的目標與偏好，讓我們為你打造專屬計畫。</p>

            <form id="setupForm">
                <div class="mb-4">
                    <label for="mainGoal">你主要想完成什麼？ (例如：考取證照、學會新技能、提升收入)</label>
                    <textarea id="mainGoal" placeholder="請描述你的主要目標..." class="rounded-md" aria-required="true"></textarea>
                </div>

                <div class="mb-4">
                    <label for="completionTime">預計在多久時間內完成？</label>
                    <select id="completionTime" class="rounded-md">
                        <option value="">請選擇</option>
                        <option value="3m">3 個月內</option>
                        <option value="6m">6 個月內</option>
                        <option value="1y">1 年內</option>
                        <option value="2y+">2 年以上</option>
                    </select>
                </div>

                <div class="mb-4">
                    <label>你希望養成的習慣類型？ (可複選)</label>
                    <div class="checkbox-group" role="group" aria-labelledby="habitTypeLabel">
                        <span id="habitTypeLabel" class="hidden">習慣類型</span>
                        <label><input type="checkbox" name="habitType" value="學習"> 學習</label>
                        <label><input type="checkbox" name="habitType" value="工作"> 工作</label>
                        <label><input type="checkbox" name="habitType" value="健康"> 健康</label>
                        <label><input type="checkbox" name="habitType" value="興趣"> 興趣</label>
                        <label><input type="checkbox" name="habitType" value="副業"> 副業</label>
                    </div>
                </div>

                <div class="mb-4">
                    <label for="habitStackingIdeas">你通常在什麼時候比較有空或想做這些事？ (例如：早餐後、午餐後、睡前)</label>
                    <textarea id="habitStackingIdeas" placeholder="請輸入你的習慣堆疊想法..." class="rounded-md"></textarea>
                </div>

                <div class="mb-4">
                    <label for="restTimePreference">你偏好的每日休息時間是？ (例如：傍晚時段、下午茶時間)</label>
                    <input type="text" id="restTimePreference" placeholder="例如：傍晚時段" class="rounded-md">
                </div>

                <button type="submit" id="startPlanButton" class="action-button w-full" aria-label="開始我的計畫">開始我的計畫！</button>
            </form>
            <div id="skipToAppContainer" class="mt-4 text-center hidden">
                <button id="skipToAppButton" class="text-blue-600 hover:underline" aria-label="直接進入主頁">直接進入主頁 →</button>
            </div>
        </div>

        <!-- 主應用程式頁面 -->
        <div id="mainAppPage" class="hidden">
            <h1 id="appTitle" aria-live="polite">個人療癒原子習慣計畫本 🌿</h1> <!-- 標題可以根據用戶輸入調整 -->

            <div class="quote-box" role="complementary" aria-label="今日語錄">
                "小步前進，終抵繁星"
                <span>靈感來自心質點：創造力與堅持，帶你走向目標。</span>
            </div>

            <!-- 新增：成就光點與心情區塊 -->
            <div class="status-section" role="region" aria-label="今日狀態">
                <div class="status-item">
                    今日心質點 ✨<span id="todayLightPoints" aria-live="polite">0</span>
                </div>
                <div class="status-item">
                    總累積心質點 🌟<span id="totalLightPoints" aria-live="polite">0</span>
                </div>
                <div class="status-item mood">
                    今日心情 😊<span id="currentMood" aria-live="polite">尚未記錄</span>
                </div>
                <div class="status-item streak-reason">
                    連續打勾理由 📝
                    <input type="text" id="streakReasonInput" placeholder="例如：為了更好的自己！" aria-label="連續打勾理由">
                    <!-- 新增儲存按鈕 -->
                    <button id="saveStreakReasonButton" class="action-button" style="padding: 5px 10px; margin-left: 10px; font-size: 0.9em;">儲存理由</button>
                </div>
                <div class="status-item">
                    連續打勾天數 🔥<span id="streakDays" aria-live="polite">0</span>
                </div>
                <div class="status-item streak-message">
                    無論今天心情美不美麗 我們終將會看到人生的彩虹
                </div>
            </div>

            <div class="task-section" role="region" aria-labelledby="dailyTaskListHeading">
                <h2 id="dailyTaskListHeading">每日任務清單</h2>
                <table class="task-table" role="grid" aria-label="每日任務">
                    <thead>
                        <tr>
                            <th scope="col">項目</th>
                            <th scope="col">任務 (MVP)</th>
                            <th scope="col">預估時間</th>
                            <th scope="col">習慣堆疊</th>
                            <th scope="col">截止日期</th> <!-- 新增截止日期欄位 -->
                            <th scope="col">重複</th> <!-- 新增重複欄位 -->
                            <th scope="col">進度</th>
                            <th scope="col">操作</th> <!-- 新增操作欄位 -->
                        </tr>
                    </thead>
                    <tbody id="taskListBody">
                        <!-- 任務將由 JavaScript 動態載入 -->
                    </tbody>
                </table>
                <!-- 任務列表為空時的提示訊息 -->
                <div id="emptyTaskListMessage" class="empty-task-list-message hidden" aria-live="polite">
                    您的任務清單目前是空的。點擊「+ 新增任務」按鈕來建立您的第一個習慣！
                </div>
            </div>

            <div class="button-group">
                <!-- 新增：刷新今日任務按鈕 (軟重置) -->
                <button class="action-button" id="refreshDailyTasksButton" aria-label="刷新今日任務">🔄 刷新今日任務</button>
                <!-- 舊的「新增今日計畫」按鈕，現在改為硬重置 -->
                <button class="action-button" id="resetToDefaultsButton" aria-label="重設並載入預設任務">✨ 重設並載入預設任務</button>
                <!-- 新增一個「新增任務」按鈕 -->
                <button class="action-button" id="addTaskButton" aria-label="新增任務">+ 新增任務</button>
                <!-- 點擊此按鈕將顯示內部生成的籤詩 -->
                <button class="action-button" id="iChingButton" aria-label="抽取今日靈感籤詩">✨ 抽取今日靈感籤詩 ✨</button>
                <!-- 新增一個「記錄心情」按鈕 -->
                <button class="action-button" id="recordMoodButton" aria-label="記錄心情">😊 記錄心情</button>
                <!-- 新增一個重設目標的按鈕，回到設定頁面 -->
                <button class="action-button" id="resetGoalsButton" aria-label="重設目標">重設目標</button>
                <!-- 新增：輸出專屬今日報告按鈕 -->
                <button class="action-button" id="exportReportButton" aria-label="輸出專屬今日報告">📋 輸出專屬今日報告</button>
                <!-- 新增：查看歷史紀錄按鈕 -->
                <button class="action-button" id="openHistoryModal" aria-label="📜 查看歷史紀錄"> 📜 查看歷史紀錄</button>
                <!-- 新增：主題切換按鈕 -->
                <button class="action-button" id="toggleThemeButton" aria-label="切換主題">🌙 切換主題</button>
            </div>

            <!-- 圖片畫廊區塊改為連結，預設顯示 -->
            <div class="image-gallery" id="foodImageGallery" role="region" aria-label="雲端視吃今天想吃的美食連結">
                <a href="https://www.pexels.com/zh-tw/search/%E7%BE%8E%E9%A3%9F/" target="_blank" rel="noopener noreferrer">
                    雲端視吃今天想吃的美食
                </a>
            </div>

            <div class="image-gallery" id="travelImageGallery" role="region" aria-label="雲端旅遊今天想去的地方連結">
                <a href="https://www.pexels.com/zh-tw/search/%E6%99%AF%E9%BB%9E/" target="_blank" rel="noopener noreferrer">
                    雲端旅遊今天想去的地方
                </a>
            </div>

            <!-- 新增：過去心情回顧區塊 -->
            <div class="mood-history-section hidden" id="moodHistorySection" role="region" aria-labelledby="moodHistoryHeading">
                <h2 id="moodHistoryHeading">過去心情回顧</h2>
                <ul id="moodHistoryList">
                    <!-- 歷史心情將由 JavaScript 動態載入 -->
                </ul>
            </div>
            <div class="button-group">
                <button class="action-button" id="toggleMoodHistoryButton" aria-label="查看或隱藏過去心情">查看/隱藏過去心情</button>
            </div>


            <div class="footer-links" role="contentinfo">
                <!-- 這些連結可以根據通用化需求調整或移除 -->
                <a href="https://www.instagram.com/adair_morton/" target="_blank" aria-label="前往 Adair Morton 的 Instagram">開發者個人Instagram</a> |
                <a href="mailto:mortonadair@gmail.com" aria-label="發送郵件至 mortonadair@gmail.com">心質點電子報</a> |
                <a href="https://line.me/ti/p/@610mnriy" target="_blank" aria-label="前往官方 LINE 帳號">心質點官方LINE</a> |
                <a href="https://forms.gle/MYAMnBpLoChpAsZV9" target="_blank" aria-label="填寫洽詢表單">心質點洽詢表單</a> |
                <a href="https://www.facebook.com/profile.php?id=61577265854856&amp;mibextid=wwXIfr&amp;rdid=ZTVlfRSgE6d6CtxO&amp;share_url=https%3A%2F%2Fwww.facebook.com%2Fshare%2F1BnpPEqYJd%2F%3Fmibextid%3DwwXIfr" target="_blank" aria-label="前往 Facebook 頁面">心質點Facebook</a> |
                <a href="https://www.instagram.com/heart_nature_aspect/" target="_blank" aria-label="前往 Heart Nature Aspect 的 Instagram">心質點Instagram</a>
            </div>
        </div>
    </div>

    <!-- 新增任務彈窗 -->
    <div id="addTaskModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="addTaskModalTitle" aria-hidden="true">
        <div class="modal-content">
            <h3 id="addTaskModalTitle">新增我的任務</h3>
            <div class="form-group">
                <label for="newTaskProject">項目：</label>
                <input type="text" id="newTaskProject" placeholder="例如：學習、工作、健康" class="rounded-md" aria-label="任務項目">
            </div>
            <div class="form-group">
                <label for="newTaskName">任務名稱：</label>
                <textarea id="newTaskName" placeholder="例如：閱讀 1 篇專業文章" class="rounded-md" aria-required="true" aria-label="任務名稱"></textarea>
            </div>
            <!-- 新增錯誤訊息顯示區塊 -->
            <div id="addTaskErrorMessage" class="error-message hidden" aria-live="assertive"></div>
            <div class="form-group">
                <label for="newTaskTime">預估時間：</label>
                <input type="text" id="newTaskTime" placeholder="例如：30 分鐘" class="rounded-md" aria-label="預估時間">
            </div>
            <div class="form-group">
                <label for="newTaskStack">習慣堆疊：</label>
                <input type="text" id="newTaskStack" placeholder="例如：早餐後、午餐後" class="rounded-md" aria-label="習慣堆疊">
            </div>
            <div class="form-group">
                <label for="newTaskPriority">優先級：</label>
                <select id="newTaskPriority" class="rounded-md" aria-label="任務優先級">
                    <option value="low">低</option>
                    <option value="medium" selected>中</option>
                    <option value="high">高</option>
                </select>
            </div>
            <div class="form-group">
                <label for="newTaskDueDate">截止日期：</label>
                <input type="date" id="newTaskDueDate" class="rounded-md" aria-label="任務截止日期">
            </div>
            <div class="form-group">
                <label for="newTaskRepeat">重複頻率：</label>
                <select id="newTaskRepeat" class="rounded-md" aria-label="任務重複頻率">
                    <option value="none">不重複</option>
                    <option value="daily">每天</option>
                    <option value="weekly">每週</option>
                    <option value="monthly">每月</option>
                </select>
            </div>
            <div class="modal-buttons">
                <button class="action-button" id="saveTaskButton" aria-label="儲存任務">儲存任務</button>
                <button class="cancel-button" id="cancelTaskButton" aria-label="取消新增任務">取消</button>
            </div>
        </div>
    </div>

    <!-- 新增：籤詩顯示彈窗 -->
    <div id="oracleModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="oracleModalTitle" aria-hidden="true">
        <div class="modal-content">
            <h3 id="oracleModalTitle">今日食衣住行心靈籤詩</h3>
            <div class="theme-options" role="radiogroup" aria-labelledby="oracleThemeLabel">
                <span id="oracleThemeLabel" class="hidden">選擇籤詩主題</span>
                <label><input type="radio" name="oracleTheme" value="random" checked aria-label="隨機籤詩"> <span>隨機</span></label>
                <label><input type="radio" name="oracleTheme" value="food" aria-label="食籤詩"> <span>食</span></label>
                <label><input type="radio" name="oracleTheme" value="clothing" aria-label="衣籤詩"> <span>衣</span></label>
                <label><input type="radio" name="oracleTheme" value="shelter" aria-label="住籤詩"> <span>住</span></label>
                <label><input type="radio" name="oracleTheme" value="transportation" aria-label="行籤詩"> <span>行</span></label>
                <label><input type="radio" name="oracleTheme" value="mind" aria-label="心籤詩"> <span>心</span></label>
            </div>
            <div id="oracleContent" class="oracle-content" aria-live="polite">
                <!-- 籤詩內容將由 JavaScript 動態生成 -->
            </div>
            <div class="modal-buttons">
                <button class="action-button" id="drawNewOracleButton" aria-label="再抽一次籤詩">再抽一次</button>
                <button class="cancel-button" id="closeOracleButton" aria-label="關閉籤詩">我知道了</button>
            </div>
        </div>
    </div>

    <!-- 新增：心情日記彈窗 -->
    <div id="moodModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="moodModalTitle" aria-hidden="true">
        <div class="modal-content">
            <h3 id="moodModalTitle">記錄今日心情</h3>
            <div class="mood-options" role="radiogroup" aria-labelledby="moodEmojiLabel">
                <span id="moodEmojiLabel" class="hidden">選擇心情表情</span>
                <label><input type="radio" name="moodEmoji" value="😊" aria-label="開心"> <span>開心</span></label>
                <label><input type="radio" name="moodEmoji" value="😌" aria-label="平靜"> <span>平靜</span></label>
                <label><input type="radio" name="moodEmoji" value="💪" aria-label="充滿活力"> <span>充滿活力</span></label>
                <label><input type="radio" name="moodEmoji" value="😴" aria-label="有點累"> <span>有點累</span></label>
                <label><input type="radio" name="moodEmoji" value="🤔" aria-label="思考中"> <span>思考中</span></label>
                <label><input type="radio" name="moodEmoji" value="😅" aria-label="壓力山大"> <span>壓力山大</span></label>
                <label><input type="radio" name="moodEmoji" value="😢" aria-label="難過"> <span>難過</span></label>
            </div>
            <div class="form-group">
                <label for="moodTextInput">詳細心情 (選填)：</label>
                <textarea id="moodTextInput" placeholder="例如：今天完成所有任務，心情超棒！或是：今天有點累，但還是堅持下來了。" class="rounded-md" aria-label="詳細心情"></textarea>
            </div>
            <div class="modal-buttons">
                <button class="action-button" id="saveMoodButton" aria-label="儲存心情">儲存心情</button>
                <button class="cancel-button" id="cancelMoodButton" aria-label="取消記錄心情">取消</button>
            </div>
        </div>
    </div>

    <!-- 匯入數據說明彈窗 -->
    <div id="importDataModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="importDataModalTitle" aria-hidden="true">
        <div class="modal-content">
            <h3 id="importDataModalTitle">匯入數據說明</h3>
            <p class="text-center text-gray-700 mb-4">
                匯入數據功能允許您從本地檔案中載入之前備份的應用程式數據。
                請注意，匯入操作將會**覆蓋現有的所有數據**，請務必謹慎。
                您的數據將會從您選擇的本地檔案路徑中讀取。
            </p>
            <div class="modal-buttons">
                <label for="actualImportFileInput" class="action-button cursor-pointer" aria-label="確認匯入數據">匯入數據</label>
                <input type="file" id="actualImportFileInput" accept="application/json" class="hidden" aria-hidden="true">
                <button class="cancel-button" id="cancelImportButton" aria-label="取消匯入數據">取消</button>
            </div>
        </div>
    </div>

    <!-- 匯出數據說明彈窗 -->
    <div id="exportDataModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="exportDataModalTitle" aria-hidden="true">
        <div class="modal-content">
            <h3 id="exportDataModalTitle">匯出數據說明</h3>
            <p class="text-center text-gray-700 mb-4">
                匯出數據功能將會把您目前在應用程式中的所有數據備份為一個 JSON 檔案。
                此檔案將會儲存到您瀏覽器的預設下載路徑。
                這是一個安全的本地備份方式，您的數據不會上傳到任何伺服器。
            </p>
            <div class="modal-buttons">
                <button class="action-button" id="confirmExportButton" aria-label="確認匯出數據">匯出數據</button>
                <button class="cancel-button" id="cancelExportButton" aria-label="取消匯出數據">取消</button>
            </div>
        </div>
    </div>

    <!-- 複製成功提示訊息 -->
    <div id="copySuccessMessage" class="hidden" role="status" aria-live="assertive">
        報告已複製到剪貼簿！
    </div>

    <!-- Custom Confirmation Modal -->
    <div id="confirmModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="confirmModalTitle" aria-hidden="true">
        <div class="modal-content">
            <h3 id="confirmModalTitle"></h3>
            <p id="confirmModalMessage" class="text-center text-gray-700 mb-4"></p>
            <div class="modal-buttons">
                <button class="action-button" id="confirmModalConfirmButton">確認</button>
                <button class="cancel-button" id="confirmModalCancelButton">取消</button>
            </div>
        </div>
    </div>

    <!-- 修改歷史紀錄彈窗表格標頭 -->
    <div id="historyModal" class="modal hidden" aria-hidden="true">
        <div class="modal-content">
            <h2>歷史紀錄</h2>
            <!-- 新增：篩選輸入框 -->
            <input type="text" id="historyFilterInput" placeholder="篩選記錄..." oninput="filterHistoryRecords()">
            <table id="historyTable" border="1">
                <thead>
                    <tr>
                        <th>日期</th>
                        <th>總累積心質點</th>
                        <th>今日心情</th>
                        <th>連續打勾理由</th>
                        <th>連續打勾天數</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- 表格內容將由 history.js 動態填充 -->
                </tbody>
            </table>
            <!-- 分頁控制容器 -->
            <div id="historyPagination" style="margin-top: 10px; text-align: center;">
                <!-- 分頁資訊將由 history.js 動態生成 -->
            </div>
            <button class="action-button" onclick="downloadCSV()">下載 CSV</button>
            <button class="action-button" onclick="importCSV()">匯入 CSV</button>
            <input type="file" id="csvFileInput" style="display: none;" accept=".csv" onchange="handleCSVImport(event)">
            <button class="action-button" onclick="closeHistoryModal()">關閉</button>
        </div>
    </div>

    <script>
        /**
         * @file 個人療癌原子習慣計畫本 - 主應用程式邏輯
         * @description 包含應用程式初始化、數據管理、UI 互動等功能。
         */

        // ====================================================================
        // 1. 全局常數定義 (CONSTANTS)
        // ====================================================================
        const CONSTANTS = {
            /**
             * 應用程式的預設每日任務列表。
             * @type {Array<Object>}
             * @property {string} id - 任務的唯一識別符。
             * @property {string} project - 任務所屬的項目類別。
             * @property {string} name - 任務的名稱。
             * @property {string} time - 任務預估所需時間。
             * @property {string} stack - 習慣堆疊的提示。
             * @property {string} priority - 任務的優先級 ('low', 'medium', 'high')。
             * @property {string} dueDate - 任務的截止日期 (YYYY-MM-DD 格式)。
             * @property {string} repeat - 任務的重複頻率 ('none', 'daily', 'weekly', 'monthly')。
             */
            DEFAULT_DAILY_TASKS: [
                { id: 'default1', project: '學習', name: '閱讀 1 篇專業文章', time: '30 分鐘', stack: '早餐後', priority: 'medium', dueDate: '', repeat: 'daily' },
                { id: 'default2', project: '工作', name: '完成 1 個小專案任務', time: '60 分鐘', stack: '上午時段', priority: 'high', dueDate: '', repeat: 'none' },
                { id: 'default3', project: '健康', name: '進行 20 分鐘輕運動', time: '20 分鐘', stack: '午餐後', priority: 'low', dueDate: '', repeat: 'daily' },
                { id: 'default4', project: '個人成長', name: '學習 1 個新軟體功能', time: '20 分鐘', stack: '下午茶時間', priority: 'medium', dueDate: '', repeat: 'weekly' },
                { id: 'default5', project: '生活', name: '整理桌面 10 分鐘', time: '10 分鐘', stack: '睡前', priority: 'low', dueDate: '', repeat: 'daily' },
                { id: 'default6', project: '心理健康', name: '進行 5 分鐘正念冥想', time: '5 分鐘', stack: '傍晚時段', priority: 'medium', dueDate: '', repeat: 'daily' }
            ],
            /**
             * 各類籤詩訊息。
             * @type {Object.<string, string[]>}
             */
            ORACLE_MESSAGES: {
                food: [
                    "今日宜品嚐異國風味，為生活增添新鮮感。<span>（或許是時候走出舒適區，給味蕾一場小冒險了，你的心渴望一點新奇！）</span>",
                    "簡單家常菜最能暖心，享受平凡的幸福。<span>（不必追求繁複，此刻的溫飽就是最好的慰藉，讓心靈沉澱在熟悉的美好中。）</span>",
                    "今日適合輕食，讓身體感受清爽與活力。<span>（聽聽身體的聲音，它渴望一份輕盈的滋養，你會感到煥然一新。）</span>",
                    "與朋友共享美食，歡樂加倍。<span>（食物因分享而更美味，連結因相聚而更緊密，讓心靈在歡聲笑語中得到滋養。）</span>",
                    "嘗試親手製作一道料理，享受創作的樂趣。<span>（從食材到餐桌，感受親手創造的滿足感，這份專注能療癒你的心。）</span>",
                    "如果感到疲憊，一份甜點或許能為你帶來小小的能量補充。<span>（別忘了，適度的犒賞也是前進的動力，你的心值得被溫柔對待。）</span>",
                    "今日味蕾渴望熟悉，重溫一份記憶中的味道吧。<span>（那份熟悉感，能帶來意想不到的安心與放鬆，讓心靈回到最舒適的港灣。）</span>",
                    "探索巷弄小店，或許會遇見一份驚喜的美味。<span>（生活總有未知的禮物，用心去感受這份期待吧！）</span>",
                    "今日適合與所愛之人共進晚餐，用心感受彼此的陪伴。<span>（餐桌上的溫暖，是心靈最好的滋養。）</span>",
                    "嘗試一份從未吃過的新鮮水果，讓味蕾感受自然的饋贈。<span>（簡單的純粹，也能帶來大大的滿足。）</span>",
                    "如果時間允許，為自己沖泡一杯香醇的咖啡或茶，享受片刻的寧靜。<span>（這份儀式感，能讓心靈找到歸屬。）</span>",
                    "今日可以規劃一場野餐，讓美食與大自然的美景相伴。<span>（在戶外用餐，感受自由與開闊。）</span>",
                    "選擇一份色彩繽紛的沙拉，讓視覺和味覺都得到愉悅。<span>（健康與美好，可以同時擁有。）</span>",
                    "在忙碌中，別忘了為自己準備一份健康的點心，補充能量。<span>（小小的照顧，累積成大大的愛。）</span>",
                    "今日適合品嚐手工製作的糕點，感受那份匠心與溫度。<span>（每一口，都是對生活細節的品味。）</span>",
                    "如果心情低落，一份熱騰騰的湯麵或許能帶來溫暖的慰藉。<span>（食物的力量，有時超乎想像。）</span>",
                    "今日可以嘗試用不同的香料烹飪，為日常增添異國情調。<span>（味蕾的冒險，也是心靈的探索。）</span>",
                    "與家人一起動手做飯，享受共同創造的樂趣。<span>（親情的連結，讓食物更加美味。）</span>",
                    "今日適合清淡飲食，讓身體感受輕盈與無負擔。<span>（給腸胃一個休息的機會，也讓心靈更清明。）</span>",
                    "如果對廚藝沒信心，點一份外賣，讓自己輕鬆享受美食。<span>（放過自己，也是一種療癒。）</span>",
                    "今日可以嘗試一份素食料理，感受植物的純粹能量。<span>（從飲食中，找到與大自然的連結。）</span>",
                    "在用餐時，專注於每一口食物的味道和口感，練習正念飲食。<span>（慢下來，你會發現更多美好。）</span>",
                    "今日適合吃一份冰淇淋，感受那份甜蜜與涼爽的療癒。<span>（偶爾的放縱，也是生活的小確幸。）</span>",
                    "如果對咖啡因敏感，試試花草茶，讓身心得到溫和的舒緩。<span>（溫潤的滋味，能安撫焦躁的心。）</span>",
                    "今日可以學習一道新的菜餚，為自己的廚藝技能加分。<span>（每一次學習，都是對自我的投資。）</span>",
                    "選擇一份當季的食材，感受大自然的節奏與新鮮。<span>（順應自然，心靈也更和諧。）</span>",
                    "今日適合與寵物共享零食時間，感受那份無條件的愛。<span>（簡單的陪伴，帶來巨大的療癒。）</span>",
                    "如果想減輕負擔，試試看斷食，讓身體有時間自我修復。<span>（傾聽身體的智慧，它會告訴你答案。）</span>",
                    "今日可以準備一份便當，為明天的自己省下時間和煩惱。<span>（提前規劃，讓生活更有餘裕。）</span>",
                    "品嚐一份手工麵包，感受那份樸實與溫暖的滋味。<span>（簡單的烘焙，也能帶來心靈的滿足。）</span>",
                    "今日適合嘗試發酵食品，為腸道健康加分。<span>（照顧好身體，是療癒的基礎。）</span>",
                    "如果時間緊迫，一份能量棒或水果也能提供快速補充。<span>（在忙碌中，也要記得關愛自己。）</span>",
                    "今日可以與朋友分享你的拿手菜，讓愛在分享中流動。<span>（分享的快樂，是雙倍的幸福。）</span>",
                    "選擇一份色彩鮮豔的蔬菜，讓餐桌充滿活力。<span>（視覺的享受，也能帶來好心情。）</span>",
                    "今日適合享受一份獨特的早午餐，開啟美好的一天。<span>（為自己創造一份特別的儀式感。）</span>",
                    "如果對甜食有慾望，選擇天然的蜂蜜或水果來滿足。<span>（健康的選擇，也能帶來甜蜜。）</span>",
                    "今日可以嘗試一份無麩質料理，探索新的飲食可能。<span>（開放的心態，能帶來新的發現。）</span>",
                    "在用餐時，關掉電子產品，專注於食物本身和當下。<span>（讓心靈真正地休息和享受。）</span>",
                    "今日適合為自己準備一份營養豐富的早餐，開啟元氣滿滿的一天。<span>（好的開始，是成功的一半。）</span>",
                    "如果對酒精有需求，選擇低酒精或無酒精飲品，享受放鬆而不失清醒。<span>（適度與平衡，是心靈的智慧。）</span>"
                ],
                clothing: [
                    "今日宜穿著舒適，自在是最好的風格。<span>（讓身體感受無拘無束，心靈也隨之放鬆，你會發現輕鬆的自己最美。）</span>",
                    "選擇亮色系衣物，為自己帶來好心情。<span>（色彩能影響情緒，給自己一點陽光吧，讓內心也跟著明亮起來！）</span>",
                    "注意天氣變化，適時增減衣物保暖。<span>（照顧好自己，是愛自己的第一步，你的身體值得被細心呵護。）</span>",
                    "搭配一件特別的飾品，展現你的獨特品味。<span>（小小的點綴，就能讓平凡的日常閃閃發光，讓你的心也感受到這份獨特。）</span>",
                    "今日適合簡約穿搭，展現自然之美。<span>（Less is more，簡單也能很有力量，讓心靈回歸純粹的舒適。）</span>",
                    "如果感到煩躁，換上一套柔軟的家居服，享受片刻的理論上。<span>（讓身體放鬆，心靈才能找到平靜，此刻的你只需要被溫柔包覆。）</span>",
                    "今日可以嘗試不同風格，給自己一個新鮮的形象。<span>（每一次的嘗試，都是對自我的探索，讓心靈也跟著煥然一新。）</span>",
                    "挑選一件讓你感到自信的衣物，讓它成為你今日的幸運符。<span>（當你感到自信，全世界都會為你讓路。）</span>",
                    "今日宜穿著寬鬆，讓身體和心靈都得到舒展。<span>（放鬆的姿態，能帶來內心的自由。）</span>",
                    "選擇天然材質的衣物，感受肌膚與自然的親密接觸。<span>（溫柔的觸感，能安撫焦躁的心。）</span>",
                    "如果心情低落，穿上你最喜歡的衣服，給自己一點儀式感。<span>（外在的改變，也能影響內心的狀態。）</span>",
                    "今日適合整理衣櫃，丟棄不再需要的，為新能量騰出空間。<span>（斷捨離，也是心靈的清理。）</span>",
                    "嘗試將舊衣物重新搭配，創造出新的風格。<span>（創意，能為生活帶來無限可能。）</span>",
                    "今日可以為自己添購一件質感好的內衣，從內而外呵護自己。<span>（看不見的細節，也值得被溫柔對待。）</span>",
                    "選擇一件有故事的古著，感受時間沉澱下的獨特魅力。<span>（每一件物品，都承載著一段故事，也連結著你的心。）</span>",
                    "今日適合穿上運動服，提醒自己該動一動了。<span>（為身體注入活力，心靈也隨之輕盈。）</span>",
                    "如果天氣微涼，披上一條柔軟的披肩，感受那份溫暖的包覆。<span>（小小的溫暖，也能帶來大大的慰藉。）</span>",
                    "今日可以嘗試DIY改造一件舊衣，讓它煥發新生。<span>（親手創造的過程，能帶來意想不到的滿足。）</span>",
                    "選擇一雙舒適的鞋子，讓每一步都輕盈自在。<span>（腳步的輕鬆，能讓心靈也感到自由。）</span>",
                    "今日適合穿上你最喜歡的顏色，讓它成為你今日的能量來源。<span>（色彩的魔力，能點亮你的心情。）</span>",
                    "如果需要出席重要場合，選擇一套讓你感到自信的服裝。<span>（外在的準備，能帶來內心的力量。）</span>",
                    "今日可以嘗試將不同材質的衣物混搭，創造層次感。<span>（探索與實驗，讓生活充滿樂趣。）</span>",
                    "選擇一件有特殊意義的衣物，讓它提醒你重要的時刻。<span>（衣物不僅是穿搭，也是記憶的載體。）</span>",
                    "今日適合穿上寬鬆的棉麻衣物，感受那份自然與透氣。<span>（讓身體自由呼吸，心靈也隨之舒展。）</span>",
                    "如果對穿搭感到困惑，不妨參考一些時尚雜誌或社群媒體尋找靈感。<span>（從他人的創意中，找到屬於自己的風格。）</span>",
                    "今日可以為自己準備一套舒適的睡衣，享受高品質的睡眠。<span>（睡前的儀式感，能帶來一夜好眠。）</span>",
                    "選擇一件有可愛圖案的T恤，讓童心在今日綻放。<span>（保持一顆童心，生活會更有趣。）</span>",
                    "今日適合穿上防風外套，即使天氣多變也能從容應對。<span>（有備無患，讓心靈更安定。）</span>",
                    "如果對環保議題有興趣，可以選擇永續材質的衣物。<span>（為地球盡一份心力，心靈也會感到富足。）</span>",
                    "今日可以嘗試將衣物進行色彩分類，讓衣櫃更整齊。<span>（秩序感，能帶來內心的平靜。）</span>",
                    "選擇一款舒適的沙發，讓它成為你放鬆身心的最佳場所。<span>（身體的放鬆，能帶來心靈的平靜。）</span>",
                    "今日適合在家中進行一次大掃除，迎接新的開始。<span>（清理舊的，才能迎接新的能量。）</span>",
                    "為餐桌添置一些鮮花，讓用餐氛圍更愉悅。<span>（花朵的美麗，能點亮生活。）</span>",
                    "今日可以嘗試在家中進行一次小型的DIY專案，享受創造的樂趣。<span>（親手創造的滿足感，是無可取代的。）</span>",
                    "如果對風水有興趣，可以學習一些居家風水知識。<span>（順應自然，讓能量流動更順暢。）</span>",
                    "今日適合在浴室泡一個熱水澡，讓身心得到徹底的放鬆。<span>（溫暖的包覆，能洗去一天的疲憊。）</span>",
                    "為玄關添置一個收納櫃，讓進出門更方便。<span>（井然有序，讓生活更從容。）</span>",
                    "今日可以嘗試在家中進行一次冥想或瑜伽練習。<span>（身心的合一，能帶來深層的平靜。）</span>",
                    "為窗邊添置一個舒適的坐墊，享受陽光下的閱讀時光。<span>（簡單的享受，也能帶來大大的幸福。）</span>",
                    "今日適合在家中舉辦一個小型的聚會，與朋友分享快樂。<span>（分享的喜悅，能讓心靈更豐盛。）</span>",
                    "如果對智能家居有興趣，可以為家中添置一些智能設備。<span>（科技的便利，能提升生活品質。）</span>",
                    "今日可以為自己準備一份健康的居家午餐，享受自製的美味。<span>（用心照顧自己，是療癒的開始。）</span>",
                    "為家中的每個角落都注入一份愛與溫暖。<span>（愛的力量，能讓家成為真正的避風港。）</span>",
                    "今日適合在睡前為臥室噴灑助眠噴霧，幫助入睡。<span>（好的睡眠，是心靈恢復的關鍵。）</span>",
                    "如果對植物養護有興趣，可以學習更多關於植物的知識。<span>（與自然連結，心靈也會感到富足。）</span>"
                ],
                transportation: [
                    "今日宜步行或騎行，感受城市的美好。<span>（放慢腳步，你會發現更多被忽略的風景，讓心靈在探索中得到放鬆。）</span>",
                    "搭乘大眾運輸工具，享受片刻的閱讀時光。<span>（將通勤時間轉化為自我提升的機會，讓心靈在知識中遨遊。）</span>",
                    "出門前檢查路線，讓行程更順暢。<span>（有準備，才能從容應對，讓心靈減少不必要的焦慮。）</span>",
                    "今日適合慢行，細細品味沿途風景。<span>（生活不只有終點，還有沿途的風景值得欣賞，讓心靈感受當下的美好。）</span>",
                    "注意交通安全，平安是最好的歸途。<span>（無論去哪裡，安全永遠是第一位，你的平安是我們最深的祝福。）</span>",
                    "如果感到煩悶，不妨選擇一條不常走的路，給自己一點新鮮感。<span>（換個視角，或許能看見不同的可能，讓心靈在未知中找到樂趣。）</span>",
                    "今日適合規劃一趟短途旅行，即使只是想像也很好。<span>（為未來儲存能量，為心靈注入期待，讓夢想帶你飛翔。）</span>",
                    "在旅途中，放鬆心情，讓思緒像窗外的風景一樣自由流動。<span>（此刻的你，只需要享受這份流動。）</span>",
                    "今日宜搭乘火車，感受鐵道旅行的浪漫與懷舊。<span>（窗外的風景，是心靈最好的畫布。）</span>",
                    "選擇一條風景優美的徒步路線，讓身體與大自然親密接觸。<span>（汗水與陽光，能洗滌心靈的疲憊。）</span>",
                    "今日適合租借共享單車，輕快地穿梭於城市巷弄間。<span>（自由的風，能吹散心頭的煩悶。）</span>",
                    "如果時間充裕，不妨選擇一條更遠的路線，享受旅途的未知。<span>（每一次的遠行，都是對自我的探索。）</span>",
                    "今日可以規劃一次海邊旅行，感受海風的輕撫與海浪的聲音。<span>（大海的遼闊，能讓心靈得到釋放。）</span>",
                    "選擇一個有特色的小鎮，漫步其中，感受當地的人文氣息。<span>（不同的文化，能帶來新的啟發。）</span>",
                    "今日適合搭乘渡輪，從海上欣賞城市的另一番風貌。<span>（水上的搖曳，能帶來獨特的平靜。）</span>",
                    "如果對歷史有興趣，可以參觀當地的古蹟或博物館。<span>（穿越時空，感受歷史的厚重與智慧。）</span>",
                    "今日可以嘗試搭乘纜車，從高處俯瞰城市全景。<span>（視野的開闊，能讓心靈也感到豁然開朗。）</span>",
                    "選擇一條有挑戰性的登山步道，挑戰自己的體能極限。<span>（征服的快感，能帶來巨大的成就感。）</span>",
                    "今日適合租借電動滑板車，輕鬆遊覽城市。<span>（科技的便利，讓探索更有趣。）</span>",
                    "如果對藝術有興趣，可以參觀當地的藝廊或文創園區。<span>（藝術的薰陶，能滋養心靈。）</span>",
                    "今日可以規劃一次露營，感受星空下的寧靜與自然。<span>（回歸自然，心靈也更純粹。）</span>",
                    "選擇一個有特色的小島，享受遠離塵囂的寧靜。<span>（島嶼的孤獨，也能帶來深層的自我對話。）</span>",
                    "今日適合搭乘觀光巴士，輕鬆遊覽城市的主要景點。<span>（放鬆身心，享受被服務的舒適。）</span>",
                    "如果對美食有追求，可以規劃一趟美食之旅。<span>（味蕾的滿足，是心靈的愉悅。）</span>",
                    "今日可以嘗試搭乘熱氣球，從空中俯瞰大地。<span>（獨特的視角，能帶來震撼的體驗。）</span>",
                    "選擇一個有故事的老街，漫步其中，感受歲月痕跡。<span>（歷史的沉澱，能帶來心靈的寧靜。）</span>",
                    "今日適合搭乘高鐵，享受快速便捷的旅程。<span>（效率與舒適，可以兼得。）</span>",
                    "如果對攝影有興趣，可以帶上相機，記錄沿途的美景。<span>（捕捉美好，讓心靈充滿感恩。）</span>",
                    "今日可以規劃一次自行車環島，挑戰自己的耐力與毅力。<span>（每一次的堅持，都是對自我的超越。）</span>",
                    "選擇一個有特色的小吃街，品嚐道地的台灣味。<span>（庶民美食，最能溫暖人心。）</span>",
                    "今日適合搭乘計程車，讓自己享受片刻的輕鬆。<span>（適度的放鬆，是為了更好的前行。）</span>",
                    "如果對探險有興趣，可以嘗試一些戶外極限運動。<span>（挑戰極限，能激發內在潛能。）</span>",
                    "今日可以規劃一次溫泉之旅，讓身心得到徹底的放鬆。<span>（溫暖的泉水，能洗去疲憊。）</span>",
                    "選擇一個有特色的小酒館，享受微醺的夜晚。<span>（放鬆身心，與朋友暢談。）</span>",
                    "今日適合搭乘捷運，感受城市的脈動與活力。<span>（快速便捷，讓生活更有效率。）</span>",
                    "如果對音樂有興趣，可以參加一場戶外音樂會。<span>（音樂的魔力，能療癒心靈。）</span>",
                    "今日可以規劃一次農場體驗，感受田園的樂趣。<span>（親近自然，心靈也更純粹。）</span>",
                    "選擇一個有特色的小咖啡館，享受悠閒的下午茶時光。<span>（咖啡的香醇，能帶來片刻的寧靜。）</span>",
                    "今日適合搭乘遊覽車，輕鬆遊覽風景名勝。<span>（舒適的旅程，讓心靈無負擔。）</span>",
                    "如果對動物有興趣，可以參觀動物園或動物保護區。<span>（與動物互動，感受生命的純真。）</span>"
                ],
                mind: [ // 新增心靈類別
                    "此刻的你，或許感到有些疲憊，請允許自己好好休息。<span>（你的努力值得被溫柔對待，心靈需要喘息的空間，別讓疲憊累積成負擔。）</span>",
                    "如果心緒不寧，不妨找個安靜的角落，深呼吸三次。<span>（每一次呼吸，都是重新開始的機會，讓心靈歸於平靜，感受當下的安穩。）</span>",
                    "別忘了，你已經很棒了。請給自己一個肯定。<span>（你所做的一切，都值得被看見，你的價值無可取代，請相信自己的光芒。）</span>",
                    "感到迷茫時，回顧一下你最初的目標和熱情。<span>（初心，是引導你前行的光，它能為你照亮方向，重新找到前進的動力。）</span>",
                    "今天，允許自己放下一些不必要的擔憂。<span>（有些事，交給時間會是最好的答案，讓心靈輕盈起來，感受無壓的自由。）</span>",
                    "如果感到孤單，記得你並不孤單，許多人都在為生活努力。<span>（連結與支持，總在你身邊，你的心是溫暖的，永遠有人與你同行。）</span>",
                    "今日，給自己一個微笑，即使只是對著鏡子。<span>（小小的善意，能開啟美好的一天，讓正能量充滿你的心，感染身邊的人。）</span>",
                    "當你感到壓力時，不妨寫下你的感受，讓情緒流動。<span>（文字是心靈的出口，釋放後你會感到輕鬆，找到內在的平靜。）</span>",
                    "允許自己不完美，成長的路上總有跌跌撞撞。<span>（接納此刻的自己，就是最好的開始，每一步都是學習的過程。）</span>",
                    "在忙碌中，為自己保留一個放空的時刻，什麼都不做也很好。<span>（心靈的留白，是為了更好的前行，讓思緒自由飛翔。）</span>",
                    "感受當下的微小幸福，或許是一杯咖啡，或許是一段音樂。<span>（幸福，常常藏在細節裡，用心去發現，你會發現處處是美好。）</span>",
                    "你的內在力量遠比你想像的更強大。相信自己。<span>（你擁有克服一切困難的潛能，勇敢地去面對挑戰吧！）不斷成長，成就更好的自己！</span>",
                    "如果感到焦慮，試著將注意力轉移到一件簡單的事情上，例如觀察窗外的雲朵。<span>（專注於當下，能有效平息內心的波瀾。）</span>",
                    "今天，給自己一個機會去原諒，無論是對自己還是對他人。<span>（放下過去的包袱，心靈才能輕裝前行。）</span>",
                    "當你感到不知所措時，不妨將大問題分解成小步驟。<span>（一步一腳印，你會發現目標其實不遠。）</span>",
                    "今日，試著對遇到的每個人都表達一份善意。<span>（付出愛，你也會收穫愛，讓世界因你而溫暖。）</span>",
                    "如果感到沮喪，回想一下你曾經克服的困難和取得的成就。<span>（你的韌性，是你最寶貴的財富。）</span>",
                    "今天，允許自己犯錯，並從中學習。<span>（錯誤是成長的養分，不必過度苛責自己。）</span>",
                    "當你感到被困住時，不妨換個環境，即使只是換個房間。<span>（環境的改變，能帶來心靈的啟發。）</span>",
                    "今日，試著對自己說一句鼓勵的話。<span>（自我的肯定，是內在力量的源泉。）</span>",
                    "如果感到迷失方向，不妨向信任的朋友或導師尋求建議。<span>（傾聽不同的聲音，能為你帶來新的視角。）</span>",
                    "今天，為自己創造一個美麗的儀式，例如點燃香薰或泡一杯花草茶。<span>（儀式感，能讓平凡的日常充滿意義。）</span>",
                    "當你感到壓力過大時，不妨暫停一下，去散步或接觸大自然。<span>（自然的療癒力，能平復你的心緒。）</span>",
                    "今日，練習感恩，列出三件讓你感到幸福的事情。<span>（感恩的心，能吸引更多美好的事物。）</span>",
                    "如果感到疲憊，不妨為自己安排一個無所事事的下午。<span>（放鬆不是浪費時間，是為了更好的出發。）</span>",
                    "今天，嘗試對自己說「沒關係」。<span>（接納不完美，是心靈自由的第一步。）</span>",
                    "當你感到情緒低落時，不妨聽聽你最喜歡的音樂。<span>（音樂的旋律，能輕撫你的心靈。）</span>",
                    "今日，給予自己一份無條件的愛與接納。<span>（你值得被愛，從自己開始。）</span>",
                    "如果感到困惑，不妨靜坐片刻，讓答案自然浮現。<span>（內在的智慧，總會給你指引。）</span>",
                    "今天，嘗試對一個陌生人微笑。<span>（小小的善意，能點亮彼此的一天。）</span>",
                    "當你感到焦慮時，不妨將注意力集中在你的呼吸上。<span>（呼吸的節奏，能帶你回到當下。）</span>",
                    "今日，允許自己哭泣，釋放累積的情緒。<span>（眼淚是心靈的雨水，洗滌後會更清澈。）</span>",
                    "如果感到孤單，不妨主動聯繫一位久未聯絡的朋友。<span>（人際的連結，能帶來溫暖與支持。）</span>",
                    "今天，為自己準備一份健康的零食，滋養身心。<span>（身體的健康，是心靈的基石。）</span>",
                    "當你感到壓力時，不妨做一些讓你感到快樂的活動。<span>（快樂是最好的解壓劑。）</span>",
                    "今日，練習冥想，讓心靈沉浸在寧靜中。<span>（片刻的寧靜，能帶來深層的療癒。）</span>",
                    "如果感到迷失，不妨回顧你的人生目標和價值觀。<span>（清晰的目標，能指引你的方向。）</span>",
                    "今天，給自己一個放鬆的夜晚，遠離電子產品。<span>（讓心靈有機會真正地休息。）</span>",
                    "當你感到不確定時，不妨相信你的直覺。<span>（內在的聲音，往往是最好的導師。）</span>",
                    "今日，為自己創造一個充滿愛的空間，即使只是角落。<span>（在愛的氛圍中，心靈才能自由綻放。）</span>"
                ]
            },
            /**
             * LocalStorage 中使用的鍵名。
             * @type {Object.<string, string>}
             */
            STORAGE_KEYS: {
                USER_SETTINGS: 'userSettings',
                USER_TASKS: 'userDefinedTasks',
                TASK_STATES: 'dailyTaskStates',
                MOOD: 'dailyMood',
                MOOD_HISTORY: 'moodHistory',
                LAST_VISIT: 'lastVisitDate',
                STREAK_DAYS: 'streakDays',
                STREAK_REASON: 'streakReason',
                TODAY_LIGHT_POINTS: 'todayLightPoints',
                TOTAL_LIGHT_POINTS: 'totalLightPoints',
                THEME_PREFERENCE: 'themePreference' // 新增主題偏好儲存鍵
            },
            /**
             * 表單驗證的相關常數。
             * @type {Object.<string, number|Function>}
             */
            VALIDATION: {
                MIN_GOAL_LENGTH: 3,
                MAX_GOAL_LENGTH: 200,
                MIN_STACKING_IDEAS: 1,
                MAX_STACKING_IDEAS: 1000,
                MIN_TASK_NAME_LENGTH: 1,
                MAX_TASK_NAME_LENGTH: 100
            },
            /**
             * 應用程式中使用的錯誤訊息。
             * @type {Object.<string, string|Function>}
             */
            ERROR_MESSAGES: {
                LOCAL_STORAGE_QUOTA: '儲存空間不足，部分資料可能無法保存。',
                LOCAL_STORAGE_GENERIC: '資料儲存或讀取失敗，請稍後再試。',
                NETWORK_OFFLINE: '您目前處於離線狀態，部分功能可能無法使用。',
                NETWORK_ONLINE: '網路已恢復連線。',
                INIT_ERROR: '初始化應用程式時發生錯誤，請刷新頁面重試。',
                GOAL_REQUIRED: '請輸入您的主要目標。',
                GOAL_TOO_SHORT: (min) => `目標至少需要 ${min} 個字元。`,
                GOAL_TOO_LONG: (max) => `目標不能超過 ${max} 個字元。`,
                HABIT_TYPES_REQUIRED: '請至少選擇一個習慣類型。',
                STACKING_IDEAS_TOO_LONG: (max) => `習慣堆疊想法不能超過 ${max} 個字元。`,
                TASK_NAME_REQUIRED: '任務名稱不能為空！',
                TASK_NAME_TOO_LONG: (max) => `任務名稱不能超過 ${max} 個字元。`,
                COPY_FAILED: '無法複製報告到剪貼簿，請手動複製。',
                IMPORT_FAILED: '匯入數據失敗，請檢查文件格式是否正確。',
                UNKNOWN_ERROR: '發生未知錯誤，請嘗試刷新頁面或聯繫支持。'
            }
        };

        // ====================================================================
        // 2. DOM 元素獲取 (Elements)
        // ====================================================================
        /**
         * 集中管理所有應用程式中使用的 DOM 元素。
         * 透過這種方式，可以避免在代碼中重複查詢 DOM，提高性能和可維護性。
         * @type {Object.<string, HTMLElement>}
         */
        const Elements = {
            setupPage: document.getElementById('setupPage'),
            mainAppPage: document.getElementById('mainAppPage'),
            setupForm: document.getElementById('setupForm'),
            startPlanButton: document.getElementById('startPlanButton'),
            skipToAppContainer: document.getElementById('skipToAppContainer'),
            skipToAppButton: document.getElementById('skipToAppButton'),
            resetGoalsButton: document.getElementById('resetGoalsButton'),
            // Renamed and new buttons
            resetToDefaultsButton: document.getElementById('resetToDefaultsButton'), // Old addNewPlanButton
            refreshDailyTasksButton: document.getElementById('refreshDailyTasksButton'), // New button
            addTaskButton: document.getElementById('addTaskButton'),
            iChingButton: document.getElementById('iChingButton'),
            recordMoodButton: document.getElementById('recordMoodButton'),
            exportReportButton: document.getElementById('exportReportButton'),
            showExportDataModalButton: document.getElementById('showExportDataModalButton'),
            showImportDataModalButton: document.getElementById('showImportDataModalButton'),
            toggleThemeButton: document.getElementById('toggleThemeButton'),
            foodImageGallery: document.getElementById('foodImageGallery'),
            travelImageGallery: document.getElementById('travelImageGallery'),
            taskListBody: document.getElementById('taskListBody'),
            appTitle: document.getElementById('appTitle'),
            emptyTaskListMessage: document.getElementById('emptyTaskListMessage'),
            todayLightPointsSpan: document.getElementById('todayLightPoints'),
            totalLightPointsSpan: document.getElementById('totalLightPoints'),
            currentMoodSpan: document.getElementById('currentMood'),
            streakDaysSpan: document.getElementById('streakDays'),
            streakReasonInput: document.getElementById('streakReasonInput'),
            addTaskModal: document.getElementById('addTaskModal'),
            addTaskModalTitle: document.getElementById('addTaskModalTitle'),
            saveTaskButton: document.getElementById('saveTaskButton'),
            cancelTaskButton: document.getElementById('cancelTaskButton'),
            newTaskProjectInput: document.getElementById('newTaskProject'),
            newTaskNameInput: document.getElementById('newTaskName'),
            newTaskTimeInput: document.getElementById('newTaskTime'),
            newTaskStackInput: document.getElementById('newTaskStack'),
            newTaskPriorityInput: document.getElementById('newTaskPriority'),
            newTaskDueDateInput: document.getElementById('newTaskDueDate'),
            newTaskRepeatInput: document.getElementById('newTaskRepeat'),
            addTaskErrorMessage: document.getElementById('addTaskErrorMessage'),
            oracleModal: document.getElementById('oracleModal'),
            oracleContent: document.getElementById('oracleContent'),
            closeOracleButton: document.getElementById('closeOracleButton'),
            drawNewOracleButton: document.getElementById('drawNewOracleButton'),
            oracleThemeRadios: document.querySelectorAll('input[name="oracleTheme"]'),
            moodModal: document.getElementById('moodModal'),
            moodTextInput: document.getElementById('moodTextInput'),
            saveMoodButton: document.getElementById('saveMoodButton'),
            cancelMoodButton: document.getElementById('cancelMoodButton'),
            moodEmojiRadios: document.querySelectorAll('input[name="moodEmoji"]'),
            moodHistorySection: document.getElementById('moodHistorySection'),
            moodHistoryList: document.getElementById('moodHistoryList'),
            toggleMoodHistoryButton: document.getElementById('toggleMoodHistoryButton'),
            copySuccessMessage: document.getElementById('copySuccessMessage'),
            loadingIndicator: document.getElementById('loadingIndicator'),
            globalErrorMessage: document.getElementById('globalErrorMessage'),
            offlineMessage: document.getElementById('offlineMessage'),
            // New modal elements
            importDataModal: document.getElementById('importDataModal'),
            exportDataModal: document.getElementById('exportDataModal'),
            actualImportFileInput: document.getElementById('actualImportFileInput'),
            confirmExportButton: document.getElementById('confirmExportButton'),
            cancelImportButton: document.getElementById('cancelImportButton'),
            cancelExportButton: document.getElementById('cancelExportButton'),
            // Custom Confirmation Modal Elements
            confirmModal: document.getElementById('confirmModal'),
            confirmModalTitle: document.getElementById('confirmModalTitle'),
            confirmModalMessage: document.getElementById('confirmModalMessage'),
            confirmModalConfirmButton: document.getElementById('confirmModalConfirmButton'),
            confirmModalCancelButton: document.getElementById('confirmModalCancelButton')
        };

        // ====================================================================
        // 3. 輔助工具函數 (Utils)
        // ====================================================================
        /**
         * 提供應用程式中通用的輔助函數，如 UI 顯示/隱藏、錯誤處理、數據格式化等。
         * @namespace Utils
         */
        const Utils = (function() {
            let confirmCallback = null; // 用於儲存確認框的回調函數

            /**
             * 顯示載入指示器。
             * @memberof Utils
             */
            function showLoading() {
                Elements.loadingIndicator.classList.add('show');
            }

            /**
             * 隱藏載入指示器。
             * @memberof Utils
             */
            function hideLoading() {
                Elements.loadingIndicator.classList.remove('show');
            }

            /**
             * 顯示指定頁面，隱藏其他頁面。
             * @param {string} pageId - 要顯示的頁面 ID ('setupPage' 或 'mainAppPage')。
             * @param {string} pageId - 要顯示的頁面 ID ('setupPage' 或 'mainAppPage')。
             * @memberof Utils
             */
            function showPage(pageId) {
                Elements.setupPage.classList.add('hidden');
                Elements.mainAppPage.classList.add('hidden');
                document.getElementById(pageId).classList.remove('hidden');
            }

            /**
             * 顯示全局錯誤訊息。
             * @param {string} message - 錯誤訊息內容。
             * @param {HTMLElement} [element=null] - 相關的表單元素，用於聚焦和定位錯誤訊息。
             * @param {number} [duration=5000] - 錯誤訊息顯示的毫秒數，0 表示永久顯示。
             * @memberof Utils
             */
            function showError(message, element = null, duration = 5000) {
                // 清除所有現有的表單特定錯誤訊息
                document.querySelectorAll('.error-message:not(#addTaskErrorMessage)').forEach(el => el.remove());

                // 顯示全局錯誤訊息
                Elements.globalErrorMessage.textContent = message;
                Elements.globalErrorMessage.classList.add('show');

                if (element) {
                    element.focus();
                    // 如果是表單相關錯誤，在元素下方顯示局部錯誤訊息
                    const localErrorElement = document.createElement('div');
                    localErrorElement.className = 'error-message';
                    localErrorElement.textContent = message;
                    element.parentNode.insertBefore(localErrorElement, element.nextSibling);
                }

                if (duration > 0) {
                    setTimeout(() => {
                        Elements.globalErrorMessage.classList.remove('show');
                        // 清除所有局部錯誤訊息
                        document.querySelectorAll('.error-message:not(#addTaskErrorMessage)').forEach(el => el.remove());
                    }, duration);
                }
            }

            /**
             * 清除指定元素下方的局部錯誤訊息。
             * @param {HTMLElement} element - 相關的表單元素。
             * @memberof Utils
             */
            function clearLocalError(element) {
                if (element && element.nextElementSibling && element.nextElementSibling.classList.contains('error-message')) {
                    element.nextElementSibling.remove();
                }
            }

            /**
             * 顯示複製成功提示訊息。
             * @memberof Utils
             */
            function showCopySuccessMessage() {
                Elements.copySuccessMessage.classList.remove('hidden');
                Elements.copySuccessMessage.classList.add('show');
                setTimeout(() => {
                    Elements.copySuccessMessage.classList.remove('show');
                    Elements.copySuccessMessage.classList.add('hidden');
                }, 2000); // 2秒後隱藏
            }

            /**
             * 簡單的 HTML 內容消毒函數，移除潛在的惡意標籤。
             * 注意：這不是一個完整的 XSS 防禦方案，對於生產環境應使用更強大的庫。
             * @param {string} text - 待消毒的字串。
             * @returns {string} 消毒後的字串。
             * @memberof Utils
             */
            function sanitizeHTML(text) {
                const div = document.createElement('div');
                div.textContent = text; // 使用 textContent 自動轉義 HTML 實體
                return div.innerHTML; // 返回轉義後的 HTML 字串
            }

            /**
             * 顯示模態框。
             * @param {HTMLElement} modalElement - 要顯示的模態框 DOM 元素。
             * @param {string} title - 模態框標題。
             * @memberof Utils
             */
            function showModal(modalElement, title) {
                modalElement.classList.remove('hidden');
                // Remove attributes that may block focus from assistive technologies
                modalElement.removeAttribute('aria-hidden');
                modalElement.removeAttribute('inert');
                // 強制重繪以觸發過渡動畫
                void modalElement.offsetWidth;
                modalElement.classList.add('show');
                // 設定標題
                const modalTitleElement = modalElement.querySelector('h3');
                if (modalTitleElement) {
                    modalTitleElement.textContent = title;
                }
                // 將焦點設定到模態框內的第一個可互動元素，以提升可訪問性
                const focusableElements = modalElement.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
                const firstFocusableElement = focusableElements[0];
                if (firstFocusableElement) {
                    firstFocusableElement.focus();
                }
            }

            /**
             * 隱藏模態框。
             * @param {HTMLElement} modalElement - 要隱藏的模態框 DOM 元素。
             * @memberof Utils
             */
            function hideModal(modalElement) {
                modalElement.classList.remove('show');
                modalElement.addEventListener('transitionend', function handler() {
                    modalElement.classList.add('hidden');
                    // Instead of using aria-hidden, add the inert attribute to prevent focus
                    modalElement.setAttribute('inert', '');
                    modalElement.removeEventListener('transitionend', handler);
                }, { once: true });
            }

            /**
             * 顯示自定義確認模態框。
             * @param {string} title - 模態框標題。
             * @param {string} message - 模態框訊息。
             * @param {Function} onConfirm - 用戶點擊「確認」時執行的回調函數。
             * @memberof Utils
             */
            function showConfirmModal(title, message, onConfirm) {
                Elements.confirmModalTitle.textContent = title;
                Elements.confirmModalMessage.textContent = message;
                confirmCallback = onConfirm; // 儲存回調函數

                // 確保先移除舊的事件監聽器，避免重複觸發
                Elements.confirmModalConfirmButton.removeEventListener('click', handleConfirmClick);
                Elements.confirmModalCancelButton.removeEventListener('click', handleCancelClick);

                Elements.confirmModalConfirmButton.addEventListener('click', handleConfirmClick);
                Elements.confirmModalCancelButton.addEventListener('click', handleCancelClick);

                Utils.showModal(Elements.confirmModal, title);
            }

            /**
             * 處理確認模態框的「確認」按鈕點擊。
             * @private
             */
            function handleConfirmClick() {
                if (confirmCallback) {
                    confirmCallback(true); // 執行回調，傳遞 true 表示確認
                }
                hideConfirmModal();
            }

            /**
             * 處理確認模態框的「取消」按鈕點擊。
             * @private
             */
            function handleCancelClick() {
                if (confirmCallback) {
                    confirmCallback(false); // 執行回調，傳遞 false 表示取消
                }
                hideConfirmModal();
            }

            /**
             * 隱藏自定義確認模態框。
             * @memberof Utils
             */
            function hideConfirmModal() {
                Utils.hideModal(Elements.confirmModal);
                confirmCallback = null; // 清除回調函數
            }


            /**
             * 請求瀏覽器通知權限。
             * @returns {Promise<boolean>} - 表示是否獲得通知權限的 Promise。
             * @memberof Utils
             */
            async function requestNotificationPermission() {
                if (!("Notification" in window)) {
                    console.warn("此瀏覽器不支持桌面通知。");
                    return false;
                }
                if (Notification.permission === "granted") {
                    return true;
                }
                if (Notification.permission !== "denied") {
                    const permission = await Notification.requestPermission();
                    return permission === "granted";
                }
                return false;
            }

            /**
             * 發送瀏覽器通知。
             * @param {string} title - 通知標題。
             * @param {object} options - 通知選項 (例如 body, icon)。
             * @memberof Utils
             */
            function sendNotification(title, options) {
                if (Notification.permission === "granted") {
                    new Notification(title, options);
                }
            }

            /**
             * 格式化日期為 YYYY-MM-DD 格式。
             * @param {Date} date - 日期物件。
             * @returns {string} 格式化後的日期字串。
             * @memberof Utils
         */
            function formatDate(date) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }

            return {
                showLoading,
                hideLoading,
                showPage,
                showError,
                clearLocalError,
                showCopySuccessMessage,
                sanitizeHTML,
                showModal,
                hideModal,
                showConfirmModal, // 新增
                hideConfirmModal, // 新增
                requestNotificationPermission,
                sendNotification,
                formatDate
            };
        })();

        // ====================================================================
        // 4. LocalStorage 管理 (StorageManager)
        // ====================================================================
        /**
         * 負責應用程式與 LocalStorage 的交互，提供統一的數據儲存、讀取和刪除接口。
         * @namespace StorageManager
         */
        const StorageManager = (function() {
            /**
             * 從 localStorage 獲取數據。
             * @param {string} key - 儲存鍵。
             * @param {any} defaultValue - 如果獲取失敗或不存在時的預設值。
             * @returns {any} 獲取的數據或預設值。
             * @memberof StorageManager
             */
            function getItem(key, defaultValue = null) {
                try {
                    const value = localStorage.getItem(key);
                    return value ? JSON.parse(value) : defaultValue;
                } catch (error) {
                    console.error(`Error getting item from localStorage for key "${key}":`, error);
                    Utils.showError(CONSTANTS.ERROR_MESSAGES.LOCAL_STORAGE_GENERIC);
                    return defaultValue;
                }
            }

            /**
             * 將數據儲存到 localStorage。
             * @param {string} key - 儲存鍵。
             * @param {any} value - 要儲存的數據。
             * @returns {boolean} 是否儲存成功。
             * @memberof StorageManager
             */
            function setItem(key, value) {
                try {
                    localStorage.setItem(key, JSON.stringify(value));
                    return true;
                } catch (error) {
                    console.error(`Error setting item to localStorage for key "${key}":`, error);
                    if (error.name === 'QuotaExceededError') {
                        Utils.showError(CONSTANTS.ERROR_MESSAGES.LOCAL_STORAGE_QUOTA);
                    } else {
                        Utils.showError(CONSTANTS.ERROR_MESSAGES.LOCAL_STORAGE_GENERIC);
                    }
                    return false;
                }
            }

            /**
             * 從 localStorage 移除數據。
             * @param {string} key - 要移除的儲存鍵。
             * @returns {boolean} 是否移除成功。
             * @memberof StorageManager
             */
            function removeItem(key) {
                try {
                    localStorage.removeItem(key);
                    return true;
                } catch (error) {
                    console.error(`Error removing item from localStorage for key "${key}":`, error);
                    Utils.showError(CONSTANTS.ERROR_MESSAGES.LOCAL_STORAGE_GENERIC);
                    return false;
                }
            }

            /**
             * 清空所有 localStorage 數據。
             * @returns {boolean} 是否清空成功。
             * @memberof StorageManager
             */
            function clearAll() {
                try {
                    localStorage.clear();
                    return true;
                } catch (error) {
                    console.error("Error clearing all localStorage:", error);
                    Utils.showError(CONSTANTS.ERROR_MESSAGES.LOCAL_STORAGE_GENERIC);
                    return false;
                }
            }

            // 新增：儲存 CSV 資料 (直接以字串存取)
            function setCSVItem(key, csvData) {
                try {
                    localStorage.setItem(key, csvData);
                    return true;
                } catch (error) {
                    console.error("儲存 CSV 資料時發生錯誤:", error);
                    return false;
                }
            }

            // 新增：讀取 CSV 資料
            function getCSVItem(key) {
                try {
                    return localStorage.getItem(key) || '';
                } catch (error) {
                    console.error("讀取 CSV 資料時發生錯誤:", error);
                    return '';
                }
            }

            return {
                getItem,
                setItem,
                removeItem,
                clearAll,
                setCSVItem,
                getCSVItem
            };
        })();
        // 假設歷史數據儲存在 localStorage，結構如：[{date: '2025-08-31', task: '學習', mood: '開心', progress: '完成'}]
const historyData = JSON.parse(localStorage.getItem('history')) || [];

// 開啟歷史 modal 並載入表格
function openHistoryModal() {
    const modal = document.getElementById('historyModal');
    Utils.showModal(modal, '歷史紀錄');
    loadHistoryTable();
}

// 關閉歷史 modal
function closeHistoryModal() {
    const modal = document.getElementById('historyModal');
    Utils.hideModal(modal);
}

// 即時載入表格數據
function loadHistoryTable() {
    const tableBody = document.querySelector('#historyTable tbody');
    tableBody.innerHTML = ''; // 清空舊數據
    historyData.forEach(item => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${item.date}</td>
            <td>${item.totalLightPoints || ''}</td>
            <td>${item.todayMood || ''}</td>
            <td>${item.checkInReason || ''}</td>
            <td>${item.consecutiveDays || ''}</td>
        `;
        tableBody.appendChild(row);
    });
}

// 下載 CSV
function downloadCSV() {
    let csvContent = "data:text/csv;charset=utf-8,";
    csvContent += "日期,總累積心質點,今日心情,連續打勾理由,連續打勾天數\n"; // 更新 CSV 標頭
    historyData.forEach(item => {
        csvContent += `${item.date},${item.totalLightPoints || ''},${item.todayMood || ''},${item.checkInReason || ''},${item.consecutiveDays || ''}\n`;
    });
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "history.csv");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// 觸發 CSV 匯入
function importCSV() {
    document.getElementById('csvFileInput').click();
}

// 處理 CSV 匯入
function handleCSVImport(event) {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const text = e.target.result;
            const lines = text.split('\n').slice(1); // 跳過標頭
            const newData = [];
            lines.forEach(line => {
                if (line.trim()) {
                    const [date, task, mood, progress] = line.split(',');
                    newData.push({ date, task, mood, progress });
                }
            });
            historyData.length = 0; // 清空舊數據（或用 push 追加，依需求調整）
            historyData.push(...newData);
            localStorage.setItem('history', JSON.stringify(historyData));
            loadHistoryTable(); // 即時更新表格
            alert('CSV 匯入成功！');
        };
        reader.readAsText(file);
    }
}

// 點擊 modal 外部關閉
window.onclick = function(event) {
    const modal = document.getElementById('historyModal');
    if (event.target === modal) {
        Utils.hideModal(modal);
    }
};

        // ====================================================================
        // 5. 任務管理 (TaskManager)
        // ====================================================================
        /**
         * 負責應用程式中任務的創建、顯示、更新和刪除邏輯。
         * @namespace TaskManager
         */
        const TaskManager = (function() {
            /**
             * 用於儲存當前正在編輯的任務 ID。
             * @type {string|null}
             * @private
             */
            let currentEditingTaskId = null;

            /**
             * 根據優先級返回對應的 CSS 類名。
             * @param {string} priority - 優先級字串 (low, medium, high)。
             * @returns {string} CSS 類名。
             * @memberof TaskManager
             */
            function getPriorityClass(priority) {
                switch (priority) {
                    case 'low': return 'priority-low';
                    case 'medium': return 'priority-medium';
                    case 'high': return 'priority-high';
                    default: return '';
                }
            }

            /**
             * 格式化重複頻率顯示。
             * @param {string} repeat - 重複頻率字串 (none, daily, weekly, monthly)。
             * @returns {string} 格式化後的顯示文字。
             * @memberof TaskManager
             */
            function formatRepeatFrequency(repeat) {
                switch (repeat) {
                    case 'daily': return '每天';
                    case 'weekly': return '每週';
                    case 'monthly': return '每月';
                    default: return '不重複';
                }
            }

            /**
             * 載入任務到 UI 並從本地儲存中恢復勾選狀態。
             * 優先載入用戶自定義任務，如果沒有則載入預設任務。
             * @memberof TaskManager
             */
            function loadTasks() {
                try {
                    Elements.taskListBody.innerHTML = ''; // 清空現有任務
                    const savedTaskStates = StorageManager.getItem(CONSTANTS.STORAGE_KEYS.TASK_STATES, {});
                    let currentTasks = StorageManager.getItem(CONSTANTS.STORAGE_KEYS.USER_TASKS, []);

                    // 如果沒有用戶自定義任務，則將預設任務複製到 userDefinedTasks
                    // 這段邏輯用於首次載入或完全重置後
                    if (currentTasks.length === 0) {
                        currentTasks = App.initializeDefaultTasks(true); // 讓 App 模組處理預設任務的初始化和 ID 生成
                    }

                    if (currentTasks.length === 0) {
                        Elements.emptyTaskListMessage.classList.remove('hidden');
                    } else {
                        Elements.emptyTaskListMessage.classList.add('hidden');
                        const fragment = document.createDocumentFragment(); // 使用 DocumentFragment 優化 DOM 操作
                        currentTasks.forEach(task => {
                            const row = document.createElement('tr');
                            const priorityClass = getPriorityClass(task.priority);
                            const dueDateDisplay = task.dueDate ? Utils.formatDate(new Date(task.dueDate)) : '無';
                            const repeatDisplay = formatRepeatFrequency(task.repeat);

                            // 使用 Utils.sanitizeHTML 確保用戶輸入的內容安全顯示
                            row.innerHTML = `
                                <td>${Utils.sanitizeHTML(task.project)}</td>
                                <td>${Utils.sanitizeHTML(task.name)} <span class="priority-tag ${priorityClass}">${Utils.sanitizeHTML(task.priority)}</span></td>
                                <td>${Utils.sanitizeHTML(task.time)}</td>
                                <td>${Utils.sanitizeHTML(task.stack)}</td>
                                <td>${dueDateDisplay}</td>
                                <td>${repeatDisplay}</td>
                                <td><input type="checkbox" id="${task.id}" data-task-id="${task.id}" ${savedTaskStates[task.id] ? 'checked' : ''} aria-label="完成任務 ${Utils.sanitizeHTML(task.name)}"></td>
                                <td>
                                    <button class="edit-button" data-task-id="${task.id}" aria-label="編輯任務 ${Utils.sanitizeHTML(task.name)}">✏️</button>
                                    <button class="delete-button" data-task-id="${task.id}" aria-label="刪除任務 ${Utils.sanitizeHTML(task.name)}">✖</button>
                                </td>
                            `;
                            fragment.appendChild(row);
                        });
                        Elements.taskListBody.appendChild(fragment);
                    }
                    App.updateStatusDisplay(); // 載入任務後更新狀態顯示
                } catch (error) {
                    console.error("載入任務時發生錯誤:", error);
                    Utils.showError("載入任務清單失敗，請嘗試刷新頁面。");
                }
            }

            /**
             * 將任務的勾選狀態儲存到本地儲存，並更新光點。
             * @param {string} taskId - 任務的唯一 ID。
             * @param {boolean} isChecked - 任務是否被勾選。
             * @memberof TaskManager
             */
            function saveTaskState(taskId, isChecked) {
                try {
                    const savedTaskStates = StorageManager.getItem(CONSTANTS.STORAGE_KEYS.TASK_STATES, {});
                    savedTaskStates[taskId] = isChecked;
                    StorageManager.setItem(CONSTANTS.STORAGE_KEYS.TASK_STATES, savedTaskStates);

                    let todayLightPoints = StorageManager.getItem(CONSTANTS.STORAGE_KEYS.TODAY_LIGHT_POINTS, 0);
                    let totalLightPoints = StorageManager.getItem(CONSTANTS.STORAGE_KEYS.TOTAL_LIGHT_POINTS, 0);

                    const targetSpan = Elements.todayLightPointsSpan;
                    const taskRow = document.querySelector(`input[data-task-id="${taskId}"]`).closest('tr');

                    if (isChecked) {
                        todayLightPoints++;
                        totalLightPoints++;
                        if (taskRow) {
                            taskRow.classList.add('task-completed-animation');
                            taskRow.addEventListener('animationend', () => {
                                taskRow.classList.remove('task-completed-animation');
                                // 可以選擇在這裡移除已完成的任務行，或僅保留視覺效果
                                // taskRow.remove();
                            }, { once: true });
                        }
                    } else {
                        todayLightPoints = Math.max(0, todayLightPoints - 1);
                        totalLightPoints = Math.max(0, totalLightPoints - 1);
                        if (taskRow) {
                            taskRow.classList.remove('task-completed-animation'); // 如果取消勾選，移除動畫類
                        }
                    }
                    StorageManager.setItem(CONSTANTS.STORAGE_KEYS.TODAY_LIGHT_POINTS, todayLightPoints);
                    StorageManager.setItem(CONSTANTS.STORAGE_KEYS.TOTAL_LIGHT_POINTS, totalLightPoints);

                    targetSpan.classList.remove('pulse-animation');
                    void targetSpan.offsetWidth; // 強制重繪
                    targetSpan.classList.add('pulse-animation');

                    App.updateStatusDisplay();

                    // 檢查是否所有任務都已完成
                    const allTasks = StorageManager.getItem(CONSTANTS.STORAGE_KEYS.USER_TASKS, []);
                    // 只有當所有當前顯示的任務都被勾選時才觸发通知
                    const allDisplayedTasksCompleted = allTasks.length > 0 && allTasks.every(task => savedTaskStates[task.id]);
                    if (allDisplayedTasksCompleted) {
                        Utils.sendNotification("恭喜！所有今日任務已完成！", {
                            body: "你今天表現得真棒！繼續保持！",
                            icon: "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🌿</text></svg>"
                        });
                    }
                } catch (error) {
                    console.error("儲存任務狀態時發生錯誤:", error);
                    Utils.showError("儲存任務狀態失敗，請稍後再試。");
                }
            }

            /**
             * 清除所有用戶任務、任務狀態、今日光點、心情和理由，並重新載入預設任務。
             * 此函數將被「重設並載入預設任務」按鈕調用 (硬重置)。
             * @memberof TaskManager
             */
            function clearAllTasksAndLoadDefaults() {
                try {
                    Utils.showLoading();
                    StorageManager.removeItem(CONSTANTS.STORAGE_KEYS.USER_TASKS); // 移除所有用戶定義的任務
                    StorageManager.removeItem(CONSTANTS.STORAGE_KEYS.TASK_STATES); // 移除所有任務狀態
                    StorageManager.setItem(CONSTANTS.STORAGE_KEYS.TODAY_LIGHT_POINTS, 0); // 重置今日光點
                    StorageManager.removeItem(CONSTANTS.STORAGE_KEYS.MOOD); // 重置今日心情
                    StorageManager.removeItem(CONSTANTS.STORAGE_KEYS.STREAK_REASON); // 重置理由
                    StorageManager.setItem(CONSTANTS.STORAGE_KEYS.STREAK_DAYS, 0); // 重置連續天數

                    App.initializeDefaultTasks(true); // 重新初始化預設任務，並強制寫入 localStorage
                    loadTasks(); // 重新載入任務，此時會載入新的預設任務
                    App.updateStatusDisplay();
                    Utils.hideLoading();
                    console.log("所有任務已重置為預設值。");
                } catch (error) {
                    console.error("重置任務時發生錯誤:", error);
                    Utils.showError("重置任務失敗，請嘗試刷新頁面。");
                    Utils.hideLoading();
                }
            }

            /**
             * 顯示新增任務彈窗。
             * @memberof TaskManager
             */
            function showAddTaskModal() {
                try {
                    currentEditingTaskId = null; // 設定為新增模式
                    Utils.showModal(Elements.addTaskModal, '新增我的任務');
                    Elements.newTaskProjectInput.value = '';
                    Elements.newTaskNameInput.value = '';
                    Elements.newTaskTimeInput.value = '';
                    Elements.newTaskStackInput.value = '';
                    Elements.newTaskPriorityInput.value = 'medium'; // 預設中等優先級
                    Elements.newTaskDueDateInput.value = ''; // 清空截止日期
                    Elements.newTaskRepeatInput.value = 'none'; // 預設不重複
                    Elements.addTaskErrorMessage.classList.add('hidden');
                    Elements.addTaskErrorMessage.textContent = '';
                } catch (error) {
                    console.error("顯示新增任務彈窗時發生錯誤:", error);
                    Utils.showError("無法開啟新增任務視窗。");
                }
            }

            /**
             * 顯示編輯任務彈窗。
             * @param {string} taskId - 要編輯的任務 ID。
             * @memberof TaskManager
             */
            function showEditTaskModal(taskId) {
                try {
                    currentEditingTaskId = taskId; // 設定為編輯模式，並儲存任務 ID
                    const tasks = StorageManager.getItem(CONSTANTS.STORAGE_KEYS.USER_TASKS, []);
                    const taskToEdit = tasks.find(task => task.id === taskId);

                    if (taskToEdit) {
                        Utils.showModal(Elements.addTaskModal, '編輯我的任務');
                        Elements.newTaskProjectInput.value = taskToEdit.project;
                        Elements.newTaskNameInput.value = taskToEdit.name;
                        Elements.newTaskTimeInput.value = taskToEdit.time;
                        Elements.newTaskStackInput.value = taskToEdit.stack;
                        Elements.newTaskPriorityInput.value = taskToEdit.priority;
                        Elements.newTaskDueDateInput.value = taskToEdit.dueDate;
                        Elements.newTaskRepeatInput.value = taskToEdit.repeat;
                        Elements.addTaskErrorMessage.classList.add('hidden');
                        Elements.addTaskErrorMessage.textContent = '';
                    } else {
                        Utils.showError('找不到要編輯的任務。');
                    }
                } catch (error) {
                    console.error("顯示編輯任務彈窗時發生錯誤:", error);
                    Utils.showError("無法開啟編輯任務視窗。");
                }
            }

            /**
             * 隱藏新增/編輯任務彈窗。
             * @memberof TaskManager
             */
            function hideAddTaskModal() {
                try {
                    Utils.hideModal(Elements.addTaskModal);
                    currentEditingTaskId = null; // 清除編輯模式
                } catch (error) {
                    console.error("隱藏新增任務彈窗時發生錯誤:", error);
                    // 這裡通常不需要向用戶顯示錯誤，因為只是隱藏 UI
                }
            }

            /**
             * 儲存新任務或更新現有任務。
             * @memberof TaskManager
             */
            function saveOrUpdateTask() {
                try {
                    const project = Elements.newTaskProjectInput.value.trim();
                    const name = Elements.newTaskNameInput.value.trim();
                    const time = Elements.newTaskTimeInput.value.trim();
                    const stack = Elements.newTaskStackInput.value.trim();
                    const priority = Elements.newTaskPriorityInput.value;
                    const dueDate = Elements.newTaskDueDateInput.value; // YYYY-MM-DD 格式
                    const repeat = Elements.newTaskRepeatInput.value;

                    if (name.length < CONSTANTS.VALIDATION.MIN_TASK_NAME_LENGTH) {
                        Elements.addTaskErrorMessage.textContent = CONSTANTS.ERROR_MESSAGES.TASK_NAME_REQUIRED;
                        Elements.addTaskErrorMessage.classList.remove('hidden');
                        return;
                    }
                    if (name.length > CONSTANTS.VALIDATION.MAX_TASK_NAME_LENGTH) {
                        Elements.addTaskErrorMessage.textContent = CONSTANTS.ERROR_MESSAGES.TASK_NAME_TOO_LONG(CONSTANTS.VALIDATION.MAX_TASK_NAME_LENGTH);
                        Elements.addTaskErrorMessage.classList.remove('hidden');
                        return;
                    }

                    Elements.addTaskErrorMessage.classList.add('hidden');

                    let userDefinedTasks = StorageManager.getItem(CONSTANTS.STORAGE_KEYS.USER_TASKS, []);

                    if (currentEditingTaskId) {
                        // 編輯現有任務
                        userDefinedTasks = userDefinedTasks.map(task => {
                            if (task.id === currentEditingTaskId) {
                                return {
                                    ...task, // 保留原有 ID 和其他未修改的屬性
                                    project: project || '未分類',
                                    name: name,
                                    time: time || '未設定',
                                    stack: stack || '未設定',
                                    priority: priority,
                                    dueDate: dueDate,
                                    repeat: repeat
                                };
                            }
                            return task;
                        });
                    } else {
                        // 新增任務
                        const newTask = {
                            id: `user-${Date.now()}`,
                            project: project || '未分類',
                            name: name,
                            time: time || '未設定',
                            stack: stack || '未設定',
                            priority: priority,
                            dueDate: dueDate,
                            repeat: repeat
                        };
                        userDefinedTasks.push(newTask);
                    }

                    StorageManager.setItem(CONSTANTS.STORAGE_KEYS.USER_TASKS, userDefinedTasks);

                    hideAddTaskModal();
                    loadTasks();
                } catch (error) {
                    console.error("儲存或更新任務時發生錯誤:", error);
                    Utils.showError("儲存任務失敗，請稍後再試。");
                }
            }

            /**
             * 刪除指定任務。
             * @param {string} taskId - 要刪除的任務 ID。
             * @memberof TaskManager
             */
            function deleteTask(taskId) {
                Utils.showConfirmModal(
                    '確認刪除任務',
                    '確定要刪除此任務嗎？此操作不可逆。',
                    (confirmed) => {
                        if (confirmed) {
                            try {
                                let userDefinedTasks = StorageManager.getItem(CONSTANTS.STORAGE_KEYS.USER_TASKS, []);
                                userDefinedTasks = userDefinedTasks.filter(task => task.id !== taskId);
                                StorageManager.setItem(CONSTANTS.STORAGE_KEYS.USER_TASKS, userDefinedTasks);

                                const savedTaskStates = StorageManager.getItem(CONSTANTS.STORAGE_KEYS.TASK_STATES, {});
                                delete savedTaskStates[taskId]; // 同步移除任務狀態
                                StorageManager.setItem(CONSTANTS.STORAGE_KEYS.TASK_STATES, savedTaskStates);

                                loadTasks();
                            } catch (error) {
                                console.error("刪除任務時發生錯誤:", error);
                                Utils.showError("刪除任務失敗，請稍後再試。");
                            }
                        } else {
                            console.log("刪除任務已取消。");
                        }
                    }
                );
            }

            return {
                loadTasks,
                saveTaskState,
                clearAllTasksAndLoadDefaults, // Renamed
                showAddTaskModal,
                showEditTaskModal,
                hideAddTaskModal,
                saveOrUpdateTask,
                deleteTask,
                formatRepeatFrequency
            };
        })();

        // ====================================================================
        // 6. 心情管理 (MoodManager)
        // ====================================================================
        /**
         * 負責應用程式中心情記錄的顯示、儲存和歷史記錄管理。
         * @namespace MoodManager
         */
        const MoodManager = (function() {
            /**
             * 顯示心情日記彈窗。
             * @memberof MoodManager
             */
            function showMoodModal() {
                try {
                    const dailyMood = StorageManager.getItem(CONSTANTS.STORAGE_KEYS.MOOD);
                    Elements.moodEmojiRadios.forEach(radio => radio.checked = false);
                    document.querySelectorAll('.mood-options label').forEach(label => label.classList.remove('selected'));

                    if (dailyMood && dailyMood.date === new Date().toDateString()) {
                        Elements.moodTextInput.value = dailyMood.text;
                        const selectedEmojiRadio = document.querySelector(`input[name="moodEmoji"][value="${dailyMood.emoji}"]`);
                        if (selectedEmojiRadio) {
                            selectedEmojiRadio.checked = true;
                            selectedEmojiRadio.closest('label').classList.add('selected');
                        }
                    } else {
                        Elements.moodTextInput.value = '';
                    }
                    Utils.showModal(Elements.moodModal, '記錄今日心情'); // 更新標題
                } catch (error) {
                    console.error("顯示心情日記彈窗時發生錯誤:", error);
                    Utils.showError("無法開啟心情記錄視窗。");
                }
            }

            /**
             * 隱藏心情日記彈窗。
             * @memberof MoodManager
             */
            function hideMoodModal() {
                try {
                    Utils.hideModal(Elements.moodModal);
                } catch (error) {
                    console.error("隱藏心情日記彈窗時發生錯誤:", error);
                }
            }

            /**
             * 儲存心情日記。
             * @memberof MoodManager
             */
            function saveMood() {
                try {
                    const selectedEmoji = document.querySelector('input[name="moodEmoji"]:checked');
                    const emoji = selectedEmoji ? selectedEmoji.value : '';
                    const moodText = Elements.moodTextInput.value.trim();

                    if (emoji || moodText) {
                        const moodData = {
                            date: new Date().toDateString(),
                            emoji: emoji,
                            text: Utils.sanitizeHTML(moodText) // 消毒用戶輸入
                        };
                        StorageManager.setItem(CONSTANTS.STORAGE_KEYS.MOOD, moodData);
                        App.updateStatusDisplay();
                    }
                    hideMoodModal();
                } catch (error) {
                    console.error("儲存心情日記時發生錯誤:", error);
                    Utils.showError("儲存心情失敗，請稍後再試。");
                }
            }

            /**
             * 顯示過去的心情歷史記錄。
             * @memberof MoodManager
             */
            function displayMoodHistory() {
                try {
                    Elements.moodHistoryList.innerHTML = '';
                    const moodHistory = StorageManager.getItem(CONSTANTS.STORAGE_KEYS.MOOD_HISTORY, []);

                    if (moodHistory.length === 0) {
                        Elements.moodHistoryList.innerHTML = '<li>目前沒有過去的心情記錄。</li>';
                        return;
                    }

                    const fragment = document.createDocumentFragment();
                    moodHistory.slice().reverse().forEach(mood => {
                        const listItem = document.createElement('li');
                        // 確保顯示的內容是消毒過的
                        listItem.innerHTML = `<strong>${mood.date}：</strong>${Utils.sanitizeHTML(mood.emoji)} ${Utils.sanitizeHTML(mood.text)}`;
                        fragment.appendChild(listItem);
                    });
                    Elements.moodHistoryList.appendChild(fragment);
                } catch (error) {
                    console.error("顯示心情歷史記錄時發生錯誤:", error);
                    Utils.showError("載入心情歷史記錄失敗。");
                }
            }

            return {
                showMoodModal,
                hideMoodModal,
                saveMood,
                displayMoodHistory
            };
        })();

        // ====================================================================
        // 7. 籤詩管理 (OracleManager)
        // ====================================================================
        /**
         * 負責籤詩的生成和顯示邏輯。
         * @namespace OracleManager
         */
        const OracleManager = (function() {
            /**
             * 生成今日食衣住行心靈籤詩。
             * @param {string} [theme='random'] - 籤詩主題 (food, clothing, shelter, transportation, mind, or random)。
             * @returns {string} 籤詩內容。
             * @memberof OracleManager
             */
            function generateFortuneCookieOracle(theme = 'random') {
                try {
                    let selectedTheme = theme;
                    if (theme === 'random') {
                        const themes = Object.keys(CONSTANTS.ORACLE_MESSAGES);
                        selectedTheme = themes[Math.floor(Math.random() * themes.length)];

                    }

                    const messages = CONSTANTS.ORACLE_MESSAGES[selectedTheme];
                    if (!messages || messages.length === 0) {
                        return "今天沒有特別的靈感，但請相信美好即將發生。<span>（生活總有驚喜，用心去感受。）</span>";
                    }
 return messages[Math.floor(Math.random() * messages.length)];
                } catch (error) {
                    console.error("生成籤詩時發生錯誤:", error);
                                       return "籤詩生成失敗，但請保持樂觀。<span>（有時候，最好的指引來自內心。）</span>";
                }
            }

            /**
             * 顯示籤詩彈窗。
             * @param {string} [initialTheme='random'] - 首次打開彈窗時的預設主題。
             * @memberof OracleManager
             */
            function showOracleModal(initialTheme = 'random') {
                try {
                    document.querySelector(`input[name="oracleTheme"][value="${initialTheme}"]`).checked = true;
                    Elements.oracleThemeRadios.forEach(radio => {
                        const label = radio.closest('label');
                        if (radio.checked) {
                            label.classList.add('selected');
                        } else {
                            label.classList.remove('selected');
                        }
                    });

                    const selectedTheme = document.querySelector('input[name="oracleTheme"]:checked').value;
                    const oracle = generateFortuneCookieOracle(selectedTheme);
                    Elements.oracleContent.innerHTML = `<p>${oracle}</p><span>（此為生活小提示，祝您有個美好的一天！）</span>`;
                    Utils.showModal(Elements.oracleModal, '今日食衣住行心靈籤詩'); // 更新標題
                } catch (error) {
                    console.error("顯示籤詩彈窗時發生錯誤:", error);
                    Utils.showError("無法開啟籤詩視窗。");
                }
            }

            /**
             * 隱藏籤詩彈窗。
             * @memberof OracleManager
             */
            function hideOracleModal() {
                try {
                    Utils.hideModal(Elements.oracleModal);
                }
                catch (error) {
                    console.error("隱藏籤詩彈窗時發生錯誤:", error);
                }
            }

            return {
                generateFortuneCookieOracle,
                showOracleModal,
                hideOracleModal
            };
        })();

        // ====================================================================
        // 8. 應用程式主邏輯 (App)
        // ====================================================================
        /**
         * 應用程式的核心邏輯模組，負責初始化、頁面導航、全局狀態管理和事件監聽。
         * @namespace App
         */
        const App = (function() {
            /**
             * 檢查是否需要重置每日數據（光點、心情、連續天數）。
             * 如果日期不同，則重置今日光點和心情，並更新連續天數。
             * @memberof App
             */
            function checkDailyReset() {
                try {
                    const today = new Date();
                    const todayString = today.toDateString();
                    const lastVisitDateString = StorageManager.getItem(CONSTANTS.STORAGE_KEYS.LAST_VISIT, '');
                    let streakDays = StorageManager.getItem(CONSTANTS.STORAGE_KEYS.STREAK_DAYS, 0);
                    let streakReason = StorageManager.getItem(CONSTANTS.STORAGE_KEYS.STREAK_REASON, '');
                    let moodHistory = StorageManager.getItem(CONSTANTS.STORAGE_KEYS.MOOD_HISTORY, []);
                    const dailyMood = StorageManager.getItem(CONSTANTS.STORAGE_KEYS.MOOD);
                    
                    if (lastVisitDateString !== todayString) {
                        const lastVisitDate = new Date(lastVisitDateString);
                        const yesterday = new Date(today);
                        yesterday.setDate(today.getDate() - 1);
                        const yesterdayString = yesterday.toDateString();

                        // 如果上次訪問是昨天，則將昨天的心情加入歷史記錄
                        if (dailyMood && dailyMood.date === lastVisitDateString) {
                            moodHistory.push(dailyMood);
                            if (moodHistory.length > 7) { // 只保留最近7天的歷史記錄
                                moodHistory = moodHistory.slice(moodHistory.length - 7);
                            }
                            StorageManager.setItem(CONSTANTS.STORAGE_KEYS.MOOD_HISTORY, moodHistory);
                        }

                        // 更新連續打勾天數
                        if (lastVisitDateString === yesterdayString) {
                            streakDays++;
                        } else {
                            streakDays = 1; // 如果不是昨天，則重置連續天數為1
                            streakReason = ''; // 重置理由
                        }
                        StorageManager.setItem(CONSTANTS.STORAGE_KEYS.STREAK_DAYS, streakDays);
                        StorageManager.setItem(CONSTANTS.STORAGE_KEYS.STREAK_REASON, streakReason);

                        // 重置今日數據
                        StorageManager.setItem(CONSTANTS.STORAGE_KEYS.TODAY_LIGHT_POINTS, 0);
                        StorageManager.removeItem(CONSTANTS.STORAGE_KEYS.MOOD);

                        // 自動刷新重複性任務的勾選狀態
                        refreshDailyTaskStates(); // 調用新的刷新函數

                        // 更新上次訪問日期
                        StorageManager.setItem(CONSTANTS.STORAGE_KEYS.LAST_VISIT, todayString);
                    }
                    updateStatusDisplay();
                    MoodManager.displayMoodHistory();
                } catch (error) {
                    console.error("檢查每日重置時發生錯誤:", error);
                    Utils.showError("每日數據重置失敗，應用程式可能無法正常運作。");
                }
            }

            /**
             * 刷新今日任務的勾選狀態 (軟重置)。
             * 將所有重複性任務 (daily, weekly, monthly) 的勾選狀態重置為未完成。
             * @memberof App
             */
            function refreshDailyTaskStates() {
                try {
                    Utils.showLoading();
                    const userTasks = StorageManager.getItem(CONSTANTS.STORAGE_KEYS.USER_TASKS, []);
                    const savedTaskStates = StorageManager.getItem(CONSTANTS.STORAGE_KEYS.TASK_STATES, {});

                    let updatedTaskStates = { ...savedTaskStates }; // 複製一份，避免直接修改

                    userTasks.forEach(task => {
                        // 針對重複性任務，將其勾選狀態重置為 false
                        if (task.repeat !== 'none') {
                            updatedTaskStates[task.id] = false;
                        }
                    });

                    StorageManager.setItem(CONSTANTS.STORAGE_KEYS.TASK_STATES, updatedTaskStates);
                    TaskManager.loadTasks(); // 重新載入任務以更新 UI
                    Utils.hideLoading();
                    console.log("今日任務已刷新。重複性任務的勾選狀態已重置。");
                } catch (error) {
                    console.error("刷新今日任務狀態時發生錯誤:", error);
                    Utils.showError("刷新任務失敗，請稍後再試。");
                    Utils.hideLoading();
                }
            }

            /**
             * 更新光點、心情、連續打勾天數的顯示。
             * @memberof App
             */
            function updateStatusDisplay() {
                try {
                    const todayLightPoints = StorageManager.getItem(CONSTANTS.STORAGE_KEYS.TODAY_LIGHT_POINTS, 0);
                    const totalLightPoints = StorageManager.getItem(CONSTANTS.STORAGE_KEYS.TOTAL_LIGHT_POINTS, 0);
                    const dailyMood = StorageManager.getItem(CONSTANTS.STORAGE_KEYS.MOOD);
                    const streakDays = StorageManager.getItem(CONSTANTS.STORAGE_KEYS.STREAK_DAYS, 0);
                    const streakReason = StorageManager.getItem(CONSTANTS.STORAGE_KEYS.STREAK_REASON, '');

                    Elements.todayLightPointsSpan.textContent = todayLightPoints;
                    Elements.totalLightPointsSpan.textContent = totalLightPoints;

                    if (dailyMood && dailyMood.date === new Date().toDateString()) {
                        Elements.currentMoodSpan.textContent = `${Utils.sanitizeHTML(dailyMood.emoji)} ${Utils.sanitizeHTML(dailyMood.text)}`;
                    } else {
                        Elements.currentMoodSpan.textContent = '尚未記錄';
                    }

                    if (streakDays > 0) {
                        Elements.streakDaysSpan.textContent = `${streakDays} 天`;
                    } else {
                        Elements.streakDaysSpan.textContent = '目前沒有連續打勾';
                    }
                    Elements.streakReasonInput.value = streakReason;
                } catch (error) {
                    console.error("更新狀態顯示時發生錯誤:", error);
                    Utils.showError("無法更新狀態顯示，部分資訊可能不正確。");
                }
            }

            /**
             * 處理設定表單提交。
             * @param {Event} event - 提交事件。
             * @memberof App
             */
            function handleSetupFormSubmit(event) {
                event.preventDefault();
                Utils.showLoading();

                try {
                    if (validateSetupForm()) {
                        const mainGoal = document.getElementById('mainGoal').value.trim();
                        const completionTime = document.getElementById('completionTime').value;
                        const habitTypes = Array.from(document.querySelectorAll('input[name="habitType"]:checked')).map(cb => cb.value);
                        const habitStackingIdeas = document.getElementById('habitStackingIdeas').value.trim();
                        const restTimePreference = document.getElementById('restTimePreference').value.trim();

                        const settings = {
                            mainGoal: Utils.sanitizeHTML(mainGoal),
                            completionTime: Utils.sanitizeHTML(completionTime),
                            habitTypes: habitTypes.map(Utils.sanitizeHTML),
                            habitStackingIdeas: Utils.sanitizeHTML(habitStackingIdeas),
                            restTimePreference: Utils.sanitizeHTML(restTimePreference),
                            setupCompleted: true,
                            setupDate: new Date().toISOString()
                        };

                        if (StorageManager.setItem(CONSTANTS.STORAGE_KEYS.USER_SETTINGS, settings)) {
                            // 在設定完成後，如果用戶任務列表為空，則初始化預設任務
                            const userTasks = StorageManager.getItem(CONSTANTS.STORAGE_KEYS.USER_TASKS, []);
                            if (userTasks.length === 0) {
                                initializeDefaultTasks(true); // 強制寫入預設任務
                            }
                            navigateToMainApp();
                        }
                    }
                } catch (error) {
                    console.error("處理設定表單提交時發生錯誤:", error);
                    Utils.showError("儲存設定失敗，請稍後再試。");
                } finally {
                    Utils.hideLoading();
                }
            }

            /**
             * 驗證設定表單。
             * @returns {boolean} 表單是否有效。
             * @memberof App
             */
            function validateSetupForm() {
                const mainGoalInput = document.getElementById('mainGoal');
                const mainGoal = mainGoalInput.value.trim();
                const habitTypes = Array.from(document.querySelectorAll('input[name="habitType"]:checked'));
                const habitStackingIdeasInput = document.getElementById('habitStackingIdeas');
                const habitStackingIdeas = habitStackingIdeasInput.value.trim();

                Utils.clearLocalError(mainGoalInput);
                Utils.clearLocalError(habitStackingIdeasInput);
                Elements.globalErrorMessage.classList.remove('show'); // 清除全局錯誤

                if (!mainGoal) {
                    Utils.showError(CONSTANTS.ERROR_MESSAGES.GOAL_REQUIRED, mainGoalInput);
                    return false;
                }
                if (mainGoal.length < CONSTANTS.VALIDATION.MIN_GOAL_LENGTH) {
                    Utils.showError(CONSTANTS.ERROR_MESSAGES.GOAL_TOO_SHORT(CONSTANTS.VALIDATION.MIN_GOAL_LENGTH), mainGoalInput);
                    return false;
                }
                if (mainGoal.length > CONSTANTS.VALIDATION.MAX_GOAL_LENGTH) {
                    Utils.showError(CONSTANTS.ERROR_MESSAGES.GOAL_TOO_LONG(CONSTANTS.VALIDATION.MAX_GOAL_LENGTH), mainGoalInput);
                    return false;
                }

                if (habitTypes.length === 0) {
                    Utils.showError(CONSTANTS.ERROR_MESSAGES.HABIT_TYPES_REQUIRED, document.querySelector('.checkbox-group'));
                    return false;
                }

                if (habitStackingIdeas.length > CONSTANTS.VALIDATION.MAX_STACKING_IDEAS) {
                    Utils.showError(CONSTANTS.ERROR_MESSAGES.STACKING_IDEAS_TOO_LONG(CONSTANTS.VALIDATION.MAX_STACKING_IDEAS), habitStackingIdeasInput);
                    return false;
                }

                return true;
            }

            /**
             * 導航到主應用程式頁面。
             * @memberof App
             */
            function navigateToMainApp() {
                try {
                    Utils.showPage('mainAppPage');
                    TaskManager.loadTasks();
                    updateStatusDisplay();

                    const userSettings = StorageManager.getItem(CONSTANTS.STORAGE_KEYS.USER_SETTINGS);
                    if (userSettings && userSettings.mainGoal) {
                        Elements.appTitle.textContent = `${userSettings.mainGoal} 習慣追蹤`;
                    } else {
                        Elements.appTitle.textContent = `個人療癒原子習慣計畫本 �`;
                    }
                } catch (error) {
                    console.error("導航到主應用程式頁面時發生錯誤:", error);
                    Utils.showError("無法載入主應用程式頁面。");
                }
            }

            /**
             * 初始化預設任務。
             * 此函數只會在用戶任務列表為空時，或被強制覆寫時，將預設任務加入 `USER_TASKS`。
             * @param {boolean} [forceOverwrite=false] - 是否強制覆寫現有用戶任務。
             * @returns {Array<Object>} 新的預設任務列表。
             * @memberof App
             */
            function initializeDefaultTasks(forceOverwrite = false) {
                try {
                    let userDefinedTasks = StorageManager.getItem(CONSTANTS.STORAGE_KEYS.USER_TASKS, []);
                    if (userDefinedTasks.length === 0 || forceOverwrite) {
                        // 複製預設任務，確保每個任務都有新的 ID，避免與用戶新增的任務 ID 衝突
                        const tasksWithNewIds = CONSTANTS.DEFAULT_DAILY_TASKS.map(task => ({
                            ...task,
                            id: `default-${Date.now()}-${Math.random().toString(36).substring(2, 9)}`
                        }));
                        StorageManager.setItem(CONSTANTS.STORAGE_KEYS.USER_TASKS, tasksWithNewIds);
                        return tasksWithNewIds;
                    }
                    return userDefinedTasks;
                } catch (error) {
                    console.error("初始化預設任務時發生錯誤:", error);
                    Utils.showError("無法初始化預設任務。");
                    return []; // 返回空陣列以避免後續錯誤
                }
            }

            /**
             * 檢查網路狀態並顯示提示。
             * @memberof App
             */
            function checkOfflineStatus() {
                if (!navigator.onLine) {
                    Elements.offlineMessage.style.display = 'block';
                } else {
                    Elements.offlineMessage.style.display = 'none';
                }
            }

            /**
             * 生成並複製今日報告文字到剪貼簿。
             * @memberof App
             */
            function generateAndCopyReport() {
                try {
                    const today = new Date().toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric' });
                    const userSettings = StorageManager.getItem(CONSTANTS.STORAGE_KEYS.USER_SETTINGS, {});
                    const todayLightPoints = StorageManager.getItem(CONSTANTS.STORAGE_KEYS.TODAY_LIGHT_POINTS, 0);
                    const totalLightPoints = StorageManager.getItem(CONSTANTS.STORAGE_KEYS.TOTAL_LIGHT_POINTS, 0);
                    const dailyMood = StorageManager.getItem(CONSTANTS.STORAGE_KEYS.MOOD);
                    const streakDays = StorageManager.getItem(CONSTANTS.STORAGE_KEYS.STREAK_DAYS, 0);
                    const streakReason = Elements.streakReasonInput.value.trim(); // 從輸入框獲取最新值
                    const currentTasks = StorageManager.getItem(CONSTANTS.STORAGE_KEYS.USER_TASKS, []);
                    const savedTaskStates = StorageManager.getItem(CONSTANTS.STORAGE_KEYS.TASK_STATES, {});
                    const moodHistory = StorageManager.getItem(CONSTANTS.STORAGE_KEYS.MOOD_HISTORY, []);

                    let reportText = `個人療癒原子習慣計畫本 - 今日報告\n`;
                    reportText += `日期：${today}\n`;
                    reportText += `========================================\n\n`;

                    reportText += `【今日語錄】\n`;
                    reportText += `"小步前進，終抵繁星"\n`;
                    reportText += `靈感來自心質點：創造力與堅持，帶你走向目標。\n\n`;

                    reportText += `【今日狀態】\n`;
                    reportText += `今日心質點：${todayLightPoints} ✨\n`;
                    reportText += `總累積心質點：${totalLightPoints} 🌟\n`;
                    reportText += `今日心情：${dailyMood ? `${dailyMood.emoji} ${dailyMood.text}` : '尚未記錄'}\n`;
                    if (streakReason) {
                        reportText += `連續打勾理由：${Utils.sanitizeHTML(streakReason)} 📝\n`;
                    }
                    reportText += `連續打勾天數：${streakDays > 0 ? `${streakDays} 天 🔥` : '目前沒有連續打勾'}\n`;
                    reportText += `\n`; // Add a newline for better formatting

                    reportText += `【每日任務清單】\n`;
                    if (currentTasks.length > 0) {
                        currentTasks.forEach(task => {
                            const status = savedTaskStates[task.id] ? '已完成 ✅' : '未完成 ❌';
                            const dueDateText = task.dueDate ? ` (截止: ${Utils.formatDate(new Date(task.dueDate))})` : '';
                            const repeatText = task.repeat && task.repeat !== 'none' ? ` (重複: ${TaskManager.formatRepeatFrequency(task.repeat)})` : '';
                            const priorityText = task.priority ? ` [優先級: ${task.priority.toUpperCase()}]` : '';

                            reportText += `項目: ${Utils.sanitizeHTML(task.project)}\n`;
                            reportText += `   任務: ${Utils.sanitizeHTML(task.name)}${priorityText}\n`;
                            reportText += `   預估時間: ${Utils.sanitizeHTML(task.time)}\n`;
                            reportText += `   習慣堆疊: ${Utils.sanitizeHTML(task.stack)}\n`;
                            reportText += `   其他資訊: ${dueDateText}${repeatText}\n`;
                            reportText += `   狀態: ${status}\n`;
                            reportText += `----------------------------------------\n`;
                        });
                    } else {
                        reportText += `您的任務清單目前是空的。\n`;
                    }
                    reportText += `\n`;

                    reportText += `【過去心情回顧】\n`;
                    if (moodHistory.length > 0) {
                        moodHistory.slice().reverse().forEach(mood => {
                            reportText += `日期: ${mood.date} - 心情: ${Utils.sanitizeHTML(mood.emoji)} ${Utils.sanitizeHTML(mood.text)}\n`;
                        });
                    } else {
                        reportText += `目前沒有過去的心情記錄。\n`;
                    }
                    reportText += `\n`;

                    reportText += `========================================\n`;
                    reportText += `「個人療癒原子習慣計畫本」祝您持續成長！\n`;
                    reportText += `更多療癒：\n`;
                    reportText += `療癒美食圖片：https://www.pexels.com/zh-tw/search/%E7%BE%8E%E9%A3%9F/\n`;
                    reportText += `旅遊景點圖片：https://www.pexels.com/zh-tw/search/%E6%99%AF%E9%BB%9E/\n`;

                    const tempTextArea = document.createElement('textarea');
                    tempTextArea.value = reportText;
                    document.body.appendChild(tempTextArea);
                    tempTextArea.select();
                    try {
                        document.execCommand('copy');
                        Utils.showCopySuccessMessage();
                    } catch (err) {
                        console.error(CONSTANTS.ERROR_MESSAGES.COPY_FAILED, err);
                        Utils.showError(CONSTANTS.ERROR_MESSAGES.COPY_FAILED);
                    } finally {
                        document.body.removeChild(tempTextArea);
                    }
                } catch (error) {
                    console.error("生成或複製報告時發生錯誤:", error);
                    Utils.showError("生成報告失敗，請稍後再試。");
                }
            }

            /**
             * 匯出所有 localStorage 數據為 JSON 文件。
             * @memberof App
             */
            function exportAllData() {
                Utils.showLoading();
                try {
                    const allData = {};
                    for (const key in CONSTANTS.STORAGE_KEYS) {
                        const storageKey = CONSTANTS.STORAGE_KEYS[key];
                        // 嘗試獲取每個儲存鍵的數據，如果不存在則為 null
                        const data = StorageManager.getItem(storageKey, null);
                        if (data !== null) { // 只匯出有數據的鍵
                             allData[storageKey] = data;
                        }
                    }

                    const dataStr = JSON.stringify(allData, null, 2); // 格式化 JSON
                    const blob = new Blob([dataStr], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `atomic_habits_backup_${new Date().toISOString().slice(0, 10)}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    Utils.showCopySuccessMessage(); // 提示匯出成功
                } catch (error) {
                    console.error("匯出數據失敗:", error);
                    Utils.showError("匯出數據失敗，請稍後再試。");
                } finally {
                    Utils.hideLoading();
                }
            }

            /**
             * 從 JSON 文件匯入數據到 localStorage。
             * @param {Event} event - 檔案輸入變更事件。
             * @memberof App
             */
            async function importData(event) {
                const file = event.target.files[0];
                if (!file) {
                    Utils.hideLoading(); // 確保在沒有文件時也隱藏載入指示器
                    return;
                }

                Utils.showLoading();
                try {
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        try {
                            const importedData = JSON.parse(e.target.result);

                            // 簡單的數據驗證：檢查是否包含預期的鍵
                            const expectedKeys = Object.values(CONSTANTS.STORAGE_KEYS);
                            const isValidData = Object.keys(importedData).some(key => expectedKeys.includes(key));

                            if (!isValidData) {
                                Utils.showError(CONSTANTS.ERROR_MESSAGES.IMPORT_FAILED + " (無效的檔案內容)");
                                return;
                            }

                            // 清空現有數據並寫入匯入數據
                            StorageManager.clearAll(); // 清空所有，確保完全覆蓋
                            for (const key in importedData) {
                                if (expectedKeys.includes(key)) { // 只匯入我們預期的鍵
                                    StorageManager.setItem(key, importedData[key]);
                                }
                            }

                            // 重新載入應用程式狀態
                            App.init(); // 重新初始化應用程式以載入新數據
                            Utils.showCopySuccessMessage(); // 提示匯入成功
                        } catch (parseError) {
                            console.error("解析匯入文件失敗:", parseError);
                            Utils.showError(CONSTANTS.ERROR_MESSAGES.IMPORT_FAILED + " (檔案格式錯誤)");
                        } finally {
                            Utils.hideLoading();
                        }
                    };
                    reader.readAsText(file);
                } catch (error) {
                    console.error("讀取匯入文件失敗:", error);
                    Utils.showError(CONSTANTS.ERROR_MESSAGES.IMPORT_FAILED);
                } finally {
                    // 清空檔案輸入，以便用戶可以再次選擇同一個檔案
                    event.target.value = '';
                }
            }

            /**
             * 切換應用程式主題 (淺色/深色模式)。
             * @memberof App

             */
            function toggleTheme() {
                try {
                    document.body.classList.toggle('dark-mode');
                    const isDarkMode = document.body.classList.contains('dark-mode');
                    StorageManager.setItem(CONSTANTS.STORAGE_KEYS.THEME_PREFERENCE, isDarkMode ? 'dark' : 'light');
                    Elements.toggleThemeButton.setAttribute('aria-label', isDarkMode ? '切換為淺色主題' : '切換為深色主題');
                    Elements.toggleThemeButton.textContent = isDarkMode ? '☀️ 切換主題' : '🌙 切換主題';
                } catch (error) {
                    console.error("切換主題時發生錯誤:", error);
                    Utils.showError("無法切換主題。");
                }
            }

            /**
             * 載入用戶主題偏好。
             * @memberof App
             */
            function loadThemePreference() {
                try {
                    const themePreference = StorageManager.getItem(CONSTANTS.STORAGE_KEYS.THEME_PREFERENCE, 'light');
                    if (themePreference === 'dark') {
                        document.body.classList.add('dark-mode');
                        Elements.toggleThemeButton.textContent = '☀️ 切換主題';
                        Elements.toggleThemeButton.setAttribute('aria-label', '切換為淺色主題');
                    } else {
                        document.body.classList.remove('dark-mode');
                        Elements.toggleThemeButton.textContent = '🌙 切換主題';
                        Elements.toggleThemeButton.setAttribute('aria-label', '切換為深色主題');
                    }
                } catch (error) {
                    console.error("載入主題偏好時發生錯誤:", error);
                    // 這裡通常不需要向用戶顯示錯誤，因為這是一個初始化步驟
                }
            }


            /**
             * 初始化所有事件監聽器。
             * @memberof App
             */
            function initializeEventListeners() {
                // 網路狀態監聽
                window.addEventListener('online', checkOfflineStatus);
                window.addEventListener('offline', checkOfflineStatus);
                // 視窗大小改變監聽 (響應式設計輔助)
                window.addEventListener('resize', () => {
                    console.log('Window resized:', window.innerWidth);
                    // 可以在這裡觸發更複雜的響應式佈局調整
                });

                // 設定頁面事件
                Elements.setupForm.addEventListener('submit', handleSetupFormSubmit);
                document.getElementById('mainGoal').addEventListener('input', () => Utils.clearLocalError(document.getElementById('mainGoal')));
                document.getElementById('habitStackingIdeas').addEventListener('input', () => Utils.clearLocalError(document.getElementById('habitStackingIdeas')));
                document.querySelectorAll('input[name="habitType"]').forEach(checkbox => {
                    checkbox.addEventListener('change', () => Utils.clearLocalError(document.querySelector('.checkbox-group')));
                });

                // 「直接進入主頁」按鈕
                if (Elements.skipToAppButton) {
                    Elements.skipToAppButton.addEventListener('click', () => {
                        navigateToMainApp();
                        TaskManager.loadTasks(); // 確保載入任務
                    });
                }

                // 主應用頁面事件
                // 新的「刷新今日任務」按鈕
                Elements.refreshDailyTasksButton.addEventListener('click', () => {
                    Utils.showConfirmModal(
                        '刷新今日任務',
                        '確定要重置所有重複性任務的勾選狀態嗎？此操作不會刪除任何任務。',
                        (confirmed) => {
                            if (confirmed) {
                                console.log("Confirm accepted for Refresh Daily Tasks.");
                                App.refreshDailyTaskStates();
                            } else {
                                console.log("Confirm cancelled for Refresh Daily Tasks.");
                            }
                        }
                    );
                });

                // 舊的「新增今日計畫」按鈕，現在改為「重設並載入預設任務」
                Elements.resetToDefaultsButton.addEventListener('click', () => {
                    Utils.showConfirmModal(
                        '重設並載入預設任務',
                        '確定要清除所有現有任務 (包括您自定義的) 並重新載入預設任務嗎？此操作不可逆。',
                        (confirmed) => {
                            if (confirmed) {
                                console.log("Confirm accepted for Reset to Defaults.");
                                TaskManager.clearAllTasksAndLoadDefaults();
                            } else {
                                console.log("Confirm cancelled for Reset to Defaults.");
                            }
                        }
                    );
                });

                Elements.addTaskButton.addEventListener('click', TaskManager.showAddTaskModal);
                Elements.saveTaskButton.addEventListener('click', TaskManager.saveOrUpdateTask); // 統一處理儲存和更新
                Elements.cancelTaskButton.addEventListener('click', TaskManager.hideAddTaskModal);
                Elements.iChingButton.addEventListener('click', () => OracleManager.showOracleModal('random'));
                Elements.drawNewOracleButton.addEventListener('click', () => {
                    const selectedTheme = document.querySelector('input[name="oracleTheme"]:checked').value;
                    const oracle = OracleManager.generateFortuneCookieOracle(selectedTheme);
                    Elements.oracleContent.innerHTML = `<p>${oracle}</p><span>（此為生活小提示，祝您有個美好的一天！）</span>`;
                });
                Elements.oracleThemeRadios.forEach(radio => {
                    radio.addEventListener('change', (event) => {
                        document.querySelectorAll('.theme-options label').forEach(label => label.classList.remove('selected'));
                        if (event.target.checked) {
                            event.target.closest('label').classList.add('selected');
                        }
                        const selectedTheme = event.target.value;
                        const oracle = OracleManager.generateFortuneCookieOracle(selectedTheme);
                        Elements.oracleContent.innerHTML = `<p>${oracle}</p><span>（此為生活小提示，祝您有個美好的一天！）</span>`;
                    });
                });
                Elements.closeOracleButton.addEventListener('click', OracleManager.hideOracleModal);
                Elements.recordMoodButton.addEventListener('click', MoodManager.showMoodModal);
                Elements.saveMoodButton.addEventListener('click', MoodManager.saveMood);
                Elements.cancelMoodButton.addEventListener('click', MoodManager.hideMoodModal);
                Elements.moodEmojiRadios.forEach(radio => {
                    radio.addEventListener('change', (event) => {
                        document.querySelectorAll('.mood-options label').forEach(label => label.classList.remove('selected'));
                        if (event.target.checked) {
                            event.target.closest('label').classList.add('selected');
                        }
                    });
                });
                Elements.streakReasonInput.addEventListener('input', (event) => {
                    StorageManager.setItem(CONSTANTS.STORAGE_KEYS.STREAK_REASON, event.target.value);
                });
                Elements.toggleMoodHistoryButton.addEventListener('click', () => {
                    Elements.moodHistorySection.classList.toggle('hidden');
                    MoodManager.displayMoodHistory();
                });
                Elements.exportReportButton.addEventListener('click', generateAndCopyReport);

                // Import/Export Modal Triggers - 僅在相關元素存在時註冊事件
                if (Elements.showExportDataModalButton) {
                    Elements.showExportDataModalButton.addEventListener('click', () => {
                        Utils.showModal(Elements.exportDataModal, '匯出數據說明');
                    });
                }
                if (Elements.showImportDataModalButton) {
                    Elements.showImportDataModalButton.addEventListener('click', () => {
                        Utils.showModal(Elements.importDataModal, '匯入數據說明');
                    });
                }
                
                // Buttons inside new modals
                Elements.confirmExportButton.addEventListener('click', () => {
                    Utils.hideModal(Elements.exportDataModal);
                });
                Elements.actualImportFileInput.addEventListener('change', (event) => {
                    Utils.hideModal(Elements.importDataModal);
                });
                Elements.cancelImportButton.addEventListener('click', () => Utils.hideModal(Elements.importDataModal));
                Elements.cancelExportButton.addEventListener('click', () => Utils.hideModal(Elements.exportDataModal));
                
                // 修復：重設目標與切換主題不能作動的問題
document.getElementById('resetGoalsButton').addEventListener('click', function(){
    // 清除用戶設定並回到設定頁面
    localStorage.removeItem('userSettings');
    document.getElementById('setupPage').classList.remove('hidden');
    document.getElementById('mainAppPage').classList.add('hidden');
});

document.getElementById('toggleThemeButton').addEventListener('click', function(){
    document.body.classList.toggle('dark-mode');
    var isDark = document.body.classList.contains('dark-mode');
    this.textContent = isDark ? '☀️ 切換主題' : '🌙 切換主題';
});
            }

            /**
             * 應用程式初始化。
             * 負責載入用戶偏好、檢查每日重置、初始化事件監聽器並導航到正確的頁面。
             * @memberof App
             */
            function init() {
                Utils.showLoading();
                try {
                    loadThemePreference(); // 載入主題偏好
                    initializeEventListeners(); // 先初始化事件監聽器
                    checkDailyReset(); // 然後檢查每日重置 (內部會調用 refreshDailyTaskStates)
                    checkOfflineStatus();

                    const userSettings = StorageManager.getItem(CONSTANTS.STORAGE_KEYS.USER_SETTINGS);
                    const setupCompleted = userSettings && userSettings.setupCompleted === true;

                    Elements.skipToAppContainer.classList.toggle('hidden', !setupCompleted);

                    if (setupCompleted) {
                        navigateToMainApp();
                    } else {
                        Utils.showPage('setupPage');
                    }
                } catch (error) {
                    console.error(CONSTANTS.ERROR_MESSAGES.INIT_ERROR, error);
                    Utils.showError(CONSTANTS.ERROR_MESSAGES.INIT_ERROR);
                } finally {
                    Utils.hideLoading();
                }
            }

            return {
                init,
                updateStatusDisplay, // 暴露給 TaskManager 和 MoodManager 調用
                navigateToMainApp, // 暴露給跳過按鈕調用
                initializeDefaultTasks, // 暴露給 TaskManager 調用
                exportAllData, // 暴露給匯出數據按鈕調用
                importData, // 暴露給匯入數據按鈕調用
                refreshDailyTaskStates // 暴露給外部調用 (例如新的刷新按鈕)
            };
        })();

        // ====================================================================
        // 9. 全域例外處理 (Global Exception Handling)
        // ====================================================================
        /**
         * 捕捉未被 try...catch 區塊處理的 JavaScript 錯誤。
         * 顯示一個全域錯誤訊息，並向控制台報告詳細錯誤資訊。
         * @param {string} message - 錯誤訊息。
         * @param {string} source - 發生錯誤的腳本 URL。
         * @param {number} lineno - 發生錯誤的行號。
         * @param {number} colno - 發生錯誤的列號。
         * @param {Error} error - 錯誤物件。
         */
        window.onerror = function(message, source, lineno, colno, error) {
            // 忽略僅顯示 "Script error." 的訊息 (無法取得詳細資訊)
            if (message === 'Script error.' && !source) {
                return true;
            }
            console.error("Unhandled error caught by window.onerror:", { message, source, lineno, colno, error });
            let errorMessage = CONSTANTS.ERROR_MESSAGES.UNKNOWN_ERROR;
            if (message) {
                errorMessage = `應用程式錯誤：${message.split('\n')[0]}`; // 只取第一行訊息
            }
            Utils.showError(errorMessage, null, 0); // 顯示錯誤訊息，0 表示永久顯示直到用戶刷新
            return true; // 返回 true 阻止瀏覽器預設的錯誤處理（例如在控制台顯示錯誤）
        };


        // 頁面載入完成後執行應用程式初始化
        document.addEventListener('DOMContentLoaded', App.init);
    </script>
    <script src="history.js"></script>
  
  <!-- 新增測試腳本以驗證 CSV 功能 -->
 //<script>
//(function(){
  //console.log("開始測試 CSV 功能...");

    // 測試：模擬歷史紀錄數據
//  const testHistory = [
//    { date: "2023-10-01", task: "學習新技術", mood: "😊", progress: "完成" },
//    { date: "2023-10-02", task: "運動", mood: "💪", progress: "進行中" }
//  ];
//  localStorage.setItem('history', JSON.stringify(testHistory));
    
    // 測試：呼叫下載 CSV 功能 (下載動作可能會觸發瀏覽器的檔案下載)
   //onsole.log("測試 downloadCSV() 函式");
    // 若不希望自動觸發下載，可將下行程式碼註解起來
    // downloadCSV();

    // 測試：呼叫 loadHistoryTable 以檢查表格正確渲染
   //onsole.log("測試 loadHistoryTable() 函式");
    // (typeof loadHistoryTable === 'function') {
   //  loadHistoryTable();
   //  console.log("loadHistoryTable 已經執行，請檢查歷史紀錄表格。");
  //} else {
  //   console.error("找不到 loadHistoryTable 函式");
 // }

  //console.log("CSV 功能測試腳本執行完畢。請檢查瀏覽器 Console 與頁面上歷史紀錄表格的內容。");
//})();
</script>
</body>
</html>
